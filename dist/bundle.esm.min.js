import{Vector3 as t,Plane as e,Line3 as i,Sphere as o,Box3 as s,Triangle as n,Layers as r,Controls as a,Quaternion as d,AnimationObjectGroup as l,AnimationMixer as c,Spherical as h,Group as u,CapsuleGeometry as p,LineSegments as m,LineBasicMaterial as v,BoxGeometry as y}from"three";function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function w(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,g(o.key),o)}}function b(t,e,i){return e&&w(t.prototype,e),i&&w(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function g(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}var _=function(){function e(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new t(0,0,0),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t(0,1,0),s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;f(this,e),this.start=i,this.end=o,this.radius=s}return b(e,[{key:"clone",value:function(){return new e(this.start.clone(),this.end.clone(),this.radius)}},{key:"set",value:function(t,e,i){this.start.copy(t),this.end.copy(e),this.radius=i}},{key:"copy",value:function(t){this.start.copy(t.start),this.end.copy(t.end),this.radius=t.radius}},{key:"getCenter",value:function(t){return t.copy(this.end).add(this.start).multiplyScalar(.5)}},{key:"translate",value:function(t){this.start.add(t),this.end.add(t)}},{key:"checkAABBAxis",value:function(t,e,i,o,s,n,r,a,d){return(s-t<d||s-i<d)&&(t-n<d||i-n<d)&&(r-e<d||r-o<d)&&(e-a<d||o-a<d)}},{key:"intersectsBox",value:function(t){return this.checkAABBAxis(this.start.x,this.start.y,this.end.x,this.end.y,t.min.x,t.max.x,t.min.y,t.max.y,this.radius)&&this.checkAABBAxis(this.start.x,this.start.z,this.end.x,this.end.z,t.min.x,t.max.x,t.min.z,t.max.z,this.radius)&&this.checkAABBAxis(this.start.y,this.start.z,this.end.y,this.end.z,t.min.y,t.max.y,t.min.z,t.max.z,this.radius)}}])}(),j=new t,k=new t,S=new t,x=new t,M=new e,D=new i,K=new i,A=new o,L=new _,O=new t,H=new t,W=new t;function P(t,e){var i,o,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=O.copy(t.end).sub(t.start),a=H.copy(e.end).sub(e.start),d=W.copy(e.start).sub(t.start),l=r.dot(a),c=r.dot(r),h=a.dot(a),u=a.dot(d),p=r.dot(d),m=c*h-l*l;if(Math.abs(m)<1e-10){var v=-u/h,y=(l-u)/h;Math.abs(v-.5)<Math.abs(y-.5)?(i=0,o=v):(i=1,o=y)}else o=((i=(u*l+p*h)/m)*l-u)/h;o=Math.max(0,Math.min(1,o)),i=Math.max(0,Math.min(1,i)),s&&s.copy(r).multiplyScalar(i).add(t.start),n&&n.copy(a).multiplyScalar(o).add(e.start)}var T=function(){function e(t){f(this,e),this.box=t,this.bounds=new s,this.subTrees=[],this.triangles=[],this.layers=new r}return b(e,[{key:"addTriangle",value:function(t){return this.bounds.min.x=Math.min(this.bounds.min.x,t.a.x,t.b.x,t.c.x),this.bounds.min.y=Math.min(this.bounds.min.y,t.a.y,t.b.y,t.c.y),this.bounds.min.z=Math.min(this.bounds.min.z,t.a.z,t.b.z,t.c.z),this.bounds.max.x=Math.max(this.bounds.max.x,t.a.x,t.b.x,t.c.x),this.bounds.max.y=Math.max(this.bounds.max.y,t.a.y,t.b.y,t.c.y),this.bounds.max.z=Math.max(this.bounds.max.z,t.a.z,t.b.z,t.c.z),this.triangles.push(t),this}},{key:"calcBox",value:function(){return this.box=this.bounds.clone(),this.box.min.x-=.01,this.box.min.y-=.01,this.box.min.z-=.01,this}},{key:"split",value:function(t){if(this.box){for(var i,o=[],n=k.copy(this.box.max).sub(this.box.min).multiplyScalar(.5),r=0;r<2;r++)for(var a=0;a<2;a++)for(var d=0;d<2;d++){var l=new s,c=j.set(r,a,d);l.min.copy(this.box.min).add(c.multiply(n)),l.max.copy(l.min).add(n),o.push(new e(l))}for(;i=this.triangles.pop();)for(var h=0;h<o.length;h++)o[h].box.intersectsTriangle(i)&&o[h].triangles.push(i);for(var u=0;u<o.length;u++){var p=o[u].triangles.length;p>8&&t<16&&o[u].split(t+1),0!==p&&this.subTrees.push(o[u])}return this}}},{key:"build",value:function(){return this.calcBox(),this.split(0),this}},{key:"getRayTriangles",value:function(t,e){for(var i=0;i<this.subTrees.length;i++){var o=this.subTrees[i];if(t.intersectsBox(o.box))if(o.triangles.length>0)for(var s=0;s<o.triangles.length;s++)-1===e.indexOf(o.triangles[s])&&e.push(o.triangles[s]);else o.getRayTriangles(t,e)}return e}},{key:"triangleCapsuleIntersect",value:function(t,e){e.getPlane(M);var i=M.distanceToPoint(t.start)-t.radius,o=M.distanceToPoint(t.end)-t.radius;if(i>0&&o>0||i<-t.radius&&o<-t.radius)return!1;var s=Math.abs(i/(Math.abs(i)+Math.abs(o))),n=j.copy(t.start).lerp(t.end,s);if(e.containsPoint(n))return{normal:M.normal.clone(),point:n.clone(),depth:Math.abs(Math.min(i,o))};for(var r=t.radius*t.radius,a=D.set(t.start,t.end),d=[[e.a,e.b],[e.b,e.c],[e.c,e.a]],l=0;l<d.length;l++){if(P(a,K.set(d[l][0],d[l][1]),S,x),S.distanceToSquared(x)<r)return{normal:S.clone().sub(x).normalize(),point:x.clone(),depth:t.radius-S.distanceTo(x)}}return!1}},{key:"triangleSphereIntersect",value:function(t,e){if(e.getPlane(M),!t.intersectsPlane(M))return!1;var i=Math.abs(M.distanceToSphere(t)),o=t.radius*t.radius-i*i,s=M.projectPoint(t.center,j);if(e.containsPoint(t.center))return{normal:M.normal.clone(),point:s.clone(),depth:Math.abs(M.distanceToSphere(t))};for(var n=[[e.a,e.b],[e.b,e.c],[e.c,e.a]],r=0;r<n.length;r++){D.set(n[r][0],n[r][1]),D.closestPointToPoint(s,!0,k);var a=k.distanceToSquared(t.center);if(a<o)return{normal:t.center.clone().sub(k).normalize(),point:k.clone(),depth:t.radius-Math.sqrt(a)}}return!1}},{key:"getSphereTriangles",value:function(t,e){for(var i=0;i<this.subTrees.length;i++){var o=this.subTrees[i];if(t.intersectsBox(o.box))if(o.triangles.length>0)for(var s=0;s<o.triangles.length;s++)-1===e.indexOf(o.triangles[s])&&e.push(o.triangles[s]);else o.getSphereTriangles(t,e)}}},{key:"getCapsuleTriangles",value:function(t,e){for(var i=0;i<this.subTrees.length;i++){var o=this.subTrees[i];if(t.intersectsBox(o.box))if(o.triangles.length>0)for(var s=0;s<o.triangles.length;s++)-1===e.indexOf(o.triangles[s])&&e.push(o.triangles[s]);else o.getCapsuleTriangles(t,e)}}},{key:"sphereIntersect",value:function(t){A.copy(t);var e,i=[],o=!1;this.getSphereTriangles(t,i);for(var s=0;s<i.length;s++)(e=this.triangleSphereIntersect(A,i[s]))&&(o=!0,A.center.add(e.normal.multiplyScalar(e.depth)));if(o){var n=A.center.clone().sub(t.center),r=n.length();return{normal:n.normalize(),depth:r}}return!1}},{key:"capsuleIntersect",value:function(e){L.copy(e);var i,o=[],s=!1;this.getCapsuleTriangles(L,o);for(var n=0;n<o.length;n++)(i=this.triangleCapsuleIntersect(L,o[n]))&&(s=!0,L.translate(i.normal.multiplyScalar(i.depth)));if(s){var r=L.getCenter(new t).sub(e.getCenter(j)),a=r.length();return{normal:r.normalize(),depth:a}}return!1}},{key:"rayIntersect",value:function(t){if(0!==t.direction.length()){var e,i,o=[],s=1e100;this.getRayTriangles(t,o);for(var n=0;n<o.length;n++){var r=t.intersectTriangle(o[n].a,o[n].b,o[n].c,!0,j);if(r){var a=r.sub(t.origin).length();s>a&&(i=r.clone().add(t.origin),s=a,e=o[n])}}return s<1e100&&{distance:s,triangle:e,position:i}}}},{key:"fromGraphNode",value:function(e){var i=this;return e.updateWorldMatrix(!0,!0),e.traverse((function(e){if(!0===e.isMesh&&i.layers.test(e.layers)){var o,s=!1;null!==e.geometry.index?(s=!0,o=e.geometry.toNonIndexed()):o=e.geometry;for(var r=o.getAttribute("position"),a=0;a<r.count;a+=3){var d=(new t).fromBufferAttribute(r,a),l=(new t).fromBufferAttribute(r,a+1),c=(new t).fromBufferAttribute(r,a+2);d.applyMatrix4(e.matrixWorld),l.applyMatrix4(e.matrixWorld),c.applyMatrix4(e.matrixWorld),i.addTriangle(new n(d,l,c))}s&&o.dispose()}})),this.build(),this}},{key:"clear",value:function(){return this.box=null,this.bounds.makeEmpty(),this.subTrees.length=0,this.triangles.length=0,this}}])}();class C extends _{constructor(t,e,i){super(t,e,i)}get height(){return this.start.distanceTo(this.end)+2*this.radius}}const E={type:"collide"};class F extends a{constructor(e,i,o,n){var r,a,d,l;super(e,i),this.velocity=new t,this._isGrounded=!1,this._deltaVelocity=new t,this._collisionPosition=new t,this._worldOctree=new T,this._worldOctree.fromGraphNode(o);const c=new t;(new s).setFromObject(this.object).getSize(c);const h=(null==n?void 0:n.colliderRadius)||c.y/4,u=(null==n?void 0:n.colliderHeight)||c.y;this._capsuleCollider=new C(new t(0,h,0),new t(0,u-h,0),h),this._capsuleCollider.translate(e.position),this.step=null!==(r=null==n?void 0:n.step)&&void 0!==r?r:5,this.gravity=null!==(a=null==n?void 0:n.gravity)&&void 0!==a?a:30,this.maxFallSpeed=null!==(d=null==n?void 0:n.maxFallSpeed)&&void 0!==d?d:20,this.movementResistance=null!==(l=null==n?void 0:n.movementResistance)&&void 0!==l?l:4,this.boundary=null==n?void 0:n.boundary}get isGrounded(){return this._isGrounded}get collider(){return this._capsuleCollider}_checkCollisions(){this._isGrounded=!1;const t=this._worldOctree.capsuleIntersect(this.collider);if(t&&(t.normal.y>0&&(this._isGrounded=!0),t.depth>=1e-10)){this.collider.translate(t.normal.multiplyScalar(t.depth));const e=this.collider.getCenter(this._collisionPosition)+t.normal.multiplyScalar(-.5*t.depth);this.dispatchEvent(Object.assign(Object.assign({},E),{position:e,normal:t.normal}))}}_teleportPlayerIfOutOfBounds(){if(!this.boundary)return;const{resetPoint:t,x:e,y:i,z:o}=this.boundary,{x:s,y:n,z:r}=this.object.position;(s<e.min||s>e.max||n<i.min||n>i.max||r<o.min||r>o.max)&&(this.collider.start.set(t.x,t.y+this.collider.radius,t.z),this.collider.end.set(t.x,t.y+this.collider.height-this.collider.radius,t.z),this.velocity.set(0,0,0))}update(t){if(!this.enabled)return;super.update(t);const e=t/this.step;for(let t=0;t<this.step;t++){let t=Math.exp(-this.movementResistance*e)-1;this._isGrounded||(this.velocity.y-=this.gravity*e,this.velocity.y=Math.max(this.velocity.y,-this.maxFallSpeed),t*=.1),this.velocity.addScaledVector(this.velocity,t),this._deltaVelocity.copy(this.velocity).multiplyScalar(e),this.collider.translate(this._deltaVelocity),this._checkCollisions(),this._teleportPlayerIfOutOfBounds()}this.object.position.copy(this.collider.start),this.object.position.y-=this.collider.radius}connect(){super.connect()}disconnect(){super.disconnect()}dispose(){super.dispose()}}const V={forward:!1,backward:!1,leftward:!1,rightward:!1,turnUp:!1,turnDown:!1,turnLeft:!1,turnRight:!1,jump:!1};class z extends F{constructor(e,i,o,s,n){var r,a,d,l,c;super(e,i,o,Object.assign({colliderHeight:1.6,colliderRadius:.5},n)),this._objectWorldDirection=new t,this._worldYDirection=new t(0,1,0),this.actionKeys=s,this.eyeHeight=null!==(r=null==n?void 0:n.eyeHeight)&&void 0!==r?r:1.5,this.jumpForce=null!==(a=null==n?void 0:n.jumpForce)&&void 0!==a?a:15,this.groundMoveSpeed=null!==(d=null==n?void 0:n.groundMoveSpeed)&&void 0!==d?d:25,this.floatMoveSpeed=null!==(l=null==n?void 0:n.floatMoveSpeed)&&void 0!==l?l:8,this.rotateSpeed=null!==(c=null==n?void 0:n.rotateSpeed)&&void 0!==c?c:1,this.onKeyDownHandler=this.onKeyDown.bind(this),this.onKeyUpHandler=this.onKeyUp.bind(this),this.connect()}getForwardVector(){return this.object.getWorldDirection(this._objectWorldDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection}getSideVector(){return this.object.getWorldDirection(this._objectWorldDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection.cross(this.object.up),this._objectWorldDirection}updateControls(t){const e=t*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);V.forward&&this.velocity.add(this.getForwardVector().multiplyScalar(e)),V.backward&&this.velocity.add(this.getForwardVector().multiplyScalar(-e)),V.leftward&&this.velocity.add(this.getSideVector().multiplyScalar(-e)),V.rightward&&this.velocity.add(this.getSideVector().multiplyScalar(e)),V.turnLeft&&this.object.rotateOnWorldAxis(this._worldYDirection,this.rotateSpeed*t),V.turnRight&&this.object.rotateOnWorldAxis(this._worldYDirection,-this.rotateSpeed*t),V.turnUp&&this.object.rotation.x<Math.PI/2-.01&&this.object.rotateX(this.rotateSpeed*t),V.turnDown&&this.object.rotation.x>-Math.PI/2+.01&&this.object.rotateX(-this.rotateSpeed*t),V.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce)}update(t){super.update(t),this.object.position.y+=this.eyeHeight,this.updateControls(t)}connect(){super.connect(),document.addEventListener("keydown",this.onKeyDownHandler),document.addEventListener("keyup",this.onKeyUpHandler)}disconnect(){super.disconnect(),document.removeEventListener("keydown",this.onKeyDownHandler),document.removeEventListener("keyup",this.onKeyUpHandler)}dispose(){this.disconnect(),super.dispose()}onKeyDown(t){for(const[e,i]of Object.entries(this.actionKeys))(null==i?void 0:i.includes(t.key))&&(V[e]=!0)}onKeyUp(t){for(const[e,i]of Object.entries(this.actionKeys))(null==i?void 0:i.includes(t.key))&&(V[e]=!1)}}const U={forward:!1,backward:!1,leftward:!1,rightward:!1,jump:!1};class I extends F{constructor(e,i,o,s,n){var r,a,d,l,c;super(e,i,o,Object.assign({colliderHeight:1.6,colliderRadius:.5},n)),this._objectWorldDirection=new t,this.actionKeys=s,this.eyeHeight=null!==(r=null==n?void 0:n.eyeHeight)&&void 0!==r?r:1.5,this.jumpForce=null!==(a=null==n?void 0:n.jumpForce)&&void 0!==a?a:15,this.groundMoveSpeed=null!==(d=null==n?void 0:n.groundMoveSpeed)&&void 0!==d?d:25,this.floatMoveSpeed=null!==(l=null==n?void 0:n.floatMoveSpeed)&&void 0!==l?l:8,this.rotateSpeed=null!==(c=null==n?void 0:n.rotateSpeed)&&void 0!==c?c:.002,this.onKeyDownHandler=this.onKeyDown.bind(this),this.onKeyUpHandler=this.onKeyUp.bind(this),this.onMouseMoveHandler=this.onMouseMove.bind(this),this.onMouseDownHandler=this.onMouseDown.bind(this),this.connect()}getForwardVector(){return this.object.getWorldDirection(this._objectWorldDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection}getSideVector(){return this.object.getWorldDirection(this._objectWorldDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection.cross(this.object.up),this._objectWorldDirection}updateControls(t){const e=t*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);U.forward&&this.velocity.add(this.getForwardVector().multiplyScalar(e)),U.backward&&this.velocity.add(this.getForwardVector().multiplyScalar(-e)),U.leftward&&this.velocity.add(this.getSideVector().multiplyScalar(-e)),U.rightward&&this.velocity.add(this.getSideVector().multiplyScalar(e)),U.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce)}update(t){super.update(t),this.object.position.y+=this.eyeHeight,this.updateControls(t)}connect(){var t;super.connect(),null===(t=this.domElement)||void 0===t||t.addEventListener("click",this.onMouseDownHandler),document.addEventListener("keydown",this.onKeyDownHandler),document.addEventListener("keyup",this.onKeyUpHandler),document.addEventListener("mousemove",this.onMouseMoveHandler)}disconnect(){var t;super.disconnect(),null===(t=this.domElement)||void 0===t||t.removeEventListener("click",this.onMouseDownHandler),document.removeEventListener("keydown",this.onKeyDownHandler),document.removeEventListener("keyup",this.onKeyUpHandler),document.removeEventListener("mousemove",this.onMouseMoveHandler)}dispose(){this.disconnect(),super.dispose()}onKeyDown(t){var e,i,o,s,n;(null===(e=this.actionKeys.forward)||void 0===e?void 0:e.some((e=>t.key===e)))&&(U.forward=!0),(null===(i=this.actionKeys.backward)||void 0===i?void 0:i.some((e=>t.key===e)))&&(U.backward=!0),(null===(o=this.actionKeys.leftward)||void 0===o?void 0:o.some((e=>t.key===e)))&&(U.leftward=!0),(null===(s=this.actionKeys.rightward)||void 0===s?void 0:s.some((e=>t.key===e)))&&(U.rightward=!0),(null===(n=this.actionKeys.jump)||void 0===n?void 0:n.some((e=>t.key===e)))&&(U.jump=!0)}onKeyUp(t){var e,i,o,s,n;(null===(e=this.actionKeys.forward)||void 0===e?void 0:e.some((e=>t.key===e)))&&(U.forward=!1),(null===(i=this.actionKeys.backward)||void 0===i?void 0:i.some((e=>t.key===e)))&&(U.backward=!1),(null===(o=this.actionKeys.leftward)||void 0===o?void 0:o.some((e=>t.key===e)))&&(U.leftward=!1),(null===(s=this.actionKeys.rightward)||void 0===s?void 0:s.some((e=>t.key===e)))&&(U.rightward=!1),(null===(n=this.actionKeys.jump)||void 0===n?void 0:n.some((e=>t.key===e)))&&(U.jump=!1)}onMouseMove(t){document.pointerLockElement===this.domElement&&(this.object.rotation.y-=t.movementX*this.rotateSpeed,this.object.rotation.x-=t.movementY*this.rotateSpeed,this.object.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.object.rotation.x)))}onMouseDown(){var t;null===(t=this.domElement)||void 0===t||t.requestPointerLock()}}class G extends F{constructor(e,i,o,s={},n={}){var r,a,h;super(e,i,o,n),this._animationClips={},this._animationActions={},this._localVelocity=new t,this._worldQuaternion=new d,this._objectGroup=new l(e),this._mixer=new c(this._objectGroup),s.animationClips&&Object.entries(s.animationClips).forEach((([t,e])=>{this.setAnimationClip(t,e)})),this.transitionTime=null!==(r=s.transitionTime)&&void 0!==r?r:.5,this.fallSpeedThreshold=null!==(a=s.fallSpeedThreshold)&&void 0!==a?a:15,this.moveSpeedThreshold=null!==(h=s.moveSpeedThreshold)&&void 0!==h?h:.1}get clips(){return Object.freeze(Object.assign({},this._animationClips))}addObject(t){this._objectGroup.add(t)}removeObject(t){this._objectGroup.remove(t)}setAnimationClip(t,e){const i=this._mixer.clipAction(e);this._animationClips[t]=e,this._animationActions[t]=i}removeAnimationClip(t){const e=this._animationClips[t];if(!e)return;const i=this._animationActions[t];i&&(i.stop(),this._mixer.uncacheAction(e,this._objectGroup)),this._mixer.uncacheClip(e),delete this._animationClips[t],delete this._animationActions[t]}_fadeToAction(t,e){const i=this._animationActions[t];i&&!i.isRunning()&&(Object.values(this._animationActions).forEach((t=>{t.fadeOut(e)})),i.reset(),i.fadeIn(e),i.play())}_updateAnimation(){const t=this.object.getWorldQuaternion(this._worldQuaternion);return this._localVelocity.copy(this.velocity).applyQuaternion(t.invert()),this.isGrounded&&this._localVelocity.z>this.moveSpeedThreshold?this._fadeToAction("forward",this.transitionTime):this.isGrounded&&this._localVelocity.z<-this.moveSpeedThreshold?this._fadeToAction("backward",this.transitionTime):this.isGrounded&&this._localVelocity.x>this.moveSpeedThreshold?this._fadeToAction("leftward",this.transitionTime):this.isGrounded&&this._localVelocity.x<-this.moveSpeedThreshold?this._fadeToAction("rightward",this.transitionTime):this.velocity.y>0?this._fadeToAction("jump",this.transitionTime):this.velocity.y<-this.fallSpeedThreshold?this._fadeToAction("fall",this.transitionTime):this.isGrounded?this._fadeToAction("idle",this.transitionTime):void 0}update(t){super.update(t),this._updateAnimation(),this._mixer.update(t)}dispose(){this._mixer.stopAllAction(),this._mixer.uncacheRoot(this._objectGroup)}}const B={forward:!1,backward:!1,leftward:!1,rightward:!1,jump:!1};class R extends G{constructor(e,i,o,s,n,r,a={},d={}){var l,c,u,p,m,v;super(e,i,o,a,d),this.cameraLerpFactor=0,this._isMouseDown=!1,this._objectWorldDirection=new t,this._accumulatedDirection=new t,this._cameraLookAtPosition=new t,this._cameraLerpPosition=new t,this._forwardDirection=new t,this.onMouseDown=()=>{this._isMouseDown=!0},this.onMouseUp=()=>{this._isMouseDown=!1},this.onMouseMove=t=>{this._isMouseDown&&(this._spherical.theta-=t.movementX*this.rotateSpeed/100,this._spherical.phi-=t.movementY*this.rotateSpeed/100,this._spherical.phi=Math.max(.01,Math.min(Math.PI-.01,this._spherical.phi)))},this.actionKeys=n,this.camera=s,this._cameraPositionOffset=r.posOffset,this._cameraLookAtOffset=r.lookAtOffset,this._spherical=new h,this.cameraLerpFactor=null!==(l=r.cameraLerpFactor)&&void 0!==l?l:0,this.updateCameraInfo(),this.axisSync=null!==(c=r.axisSync)&&void 0!==c?c:"move",this.jumpForce=null!==(u=null==d?void 0:d.jumpForce)&&void 0!==u?u:15,this.groundMoveSpeed=null!==(p=null==d?void 0:d.groundMoveSpeed)&&void 0!==p?p:25,this.floatMoveSpeed=null!==(m=null==d?void 0:d.floatMoveSpeed)&&void 0!==m?m:8,this.rotateSpeed=null!==(v=null==d?void 0:d.rotateSpeed)&&void 0!==v?v:1,this.onKeyDownHandler=this.onKeyDown.bind(this),this.onKeyUpHandler=this.onKeyUp.bind(this),this.onMouseDownHandler=this.onMouseDown.bind(this),this.onMouseUpHandler=this.onMouseUp.bind(this),this.onMouseMoveHandler=this.onMouseMove.bind(this),this.connect()}get cameraPosOffset(){return this._cameraPositionOffset}set cameraPosOffset(t){this._cameraPositionOffset=t,this.updateCameraInfo()}get cameraLookAtOffset(){return this._cameraLookAtOffset}set cameraLookAtOffset(t){this._cameraLookAtOffset=t,this.updateCameraInfo()}updateCameraInfo(){const t=this._cameraPositionOffset.clone().sub(this._cameraLookAtOffset);this._spherical.setFromVector3(t)}getForwardVector(){return this._objectWorldDirection.copy(this._forwardDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection}getSideVector(){return this._objectWorldDirection.copy(this._forwardDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection.cross(this.object.up),this._objectWorldDirection}updateSync(){return"always"===this.axisSync||"move"===this.axisSync&&(B.forward||B.backward||B.leftward||B.rightward)?(this.camera.getWorldDirection(this._forwardDirection),void this.object.lookAt(this.object.position.clone().add(this.getForwardVector()))):void 0}updateControls(t){const e=t*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed),i=this._accumulatedDirection.set(0,0,0);B.leftward&&i.add(this.getSideVector().multiplyScalar(-1)),B.rightward&&i.add(this.getSideVector()),B.backward&&i.add(this.getForwardVector().multiplyScalar(-1)),B.forward&&i.add(this.getForwardVector()),i.lengthSq()>1e-10&&(i.normalize(),this.velocity.add(i.multiplyScalar(e)),this.object.lookAt(this.object.position.clone().add(i))),B.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce)}updateCamera(){this.object.updateMatrixWorld();const t=this._cameraLerpPosition.addVectors(this.object.position,this._cameraLookAtOffset),e=this._cameraLookAtPosition;if(this.cameraLerpFactor>0){const i=e.distanceTo(t);e.lerp(t,this.cameraLerpFactor*i)}else e.copy(t);this.camera.position.setFromSpherical(this._spherical).add(e),this.camera.lookAt(e)}update(t){super.update(t),this.updateCamera(),this.updateSync(),this.updateControls(t)}connect(){var t,e;super.connect(),document.addEventListener("keydown",this.onKeyDownHandler),document.addEventListener("keyup",this.onKeyUpHandler),null===(t=this.domElement)||void 0===t||t.addEventListener("mousedown",this.onMouseDownHandler),document.addEventListener("mouseup",this.onMouseUpHandler),null===(e=this.domElement)||void 0===e||e.addEventListener("mousemove",this.onMouseMoveHandler)}disconnect(){var t,e;super.disconnect(),document.removeEventListener("keydown",this.onKeyDownHandler),document.removeEventListener("keyup",this.onKeyUpHandler),null===(t=this.domElement)||void 0===t||t.removeEventListener("mousedown",this.onMouseDownHandler),document.removeEventListener("mouseup",this.onMouseUpHandler),null===(e=this.domElement)||void 0===e||e.removeEventListener("mousemove",this.onMouseMoveHandler)}dispose(){this.disconnect(),super.dispose()}onKeyDown(t){var e,i,o,s,n;(null===(e=this.actionKeys.forward)||void 0===e?void 0:e.some((e=>t.key===e)))&&(B.forward=!0),(null===(i=this.actionKeys.backward)||void 0===i?void 0:i.some((e=>t.key===e)))&&(B.backward=!0),(null===(o=this.actionKeys.leftward)||void 0===o?void 0:o.some((e=>t.key===e)))&&(B.leftward=!0),(null===(s=this.actionKeys.rightward)||void 0===s?void 0:s.some((e=>t.key===e)))&&(B.rightward=!0),(null===(n=this.actionKeys.jump)||void 0===n?void 0:n.some((e=>t.key===e)))&&(B.jump=!0)}onKeyUp(t){var e,i,o,s,n;(null===(e=this.actionKeys.forward)||void 0===e?void 0:e.some((e=>t.key===e)))&&(B.forward=!1),(null===(i=this.actionKeys.backward)||void 0===i?void 0:i.some((e=>t.key===e)))&&(B.backward=!1),(null===(o=this.actionKeys.leftward)||void 0===o?void 0:o.some((e=>t.key===e)))&&(B.leftward=!1),(null===(s=this.actionKeys.rightward)||void 0===s?void 0:s.some((e=>t.key===e)))&&(B.rightward=!1),(null===(n=this.actionKeys.jump)||void 0===n?void 0:n.some((e=>t.key===e)))&&(B.jump=!1)}}const q={forward:!1,backward:!1,leftward:!1,rightward:!1,jump:!1};class Y extends G{constructor(e,i,o,s,n,r,a={},d={}){var l,c,u,p,m;super(e,i,o,a,d),this._objectWorldDirection=new t,this._accumulatedDirection=new t,this._cameraLookAtPosition=new t,this._forwardDirection=new t,this.onMouseDown=()=>{var t;null===(t=this.domElement)||void 0===t||t.requestPointerLock()},this.onMouseMove=t=>{document.pointerLockElement===this.domElement&&(this._spherical.theta-=t.movementX*this.rotateSpeed/100,this._spherical.phi-=t.movementY*this.rotateSpeed/100,this._spherical.phi=Math.max(.01,Math.min(Math.PI-.01,this._spherical.phi)))},this.actionKeys=n,this.camera=s,this._cameraPositionOffset=r.posOffset,this._cameraLookAtOffset=r.lookAtOffset,this._spherical=new h,this.updateCameraInfo(),this.object.getWorldDirection(this._forwardDirection),this.axisSync=null!==(l=r.axisSync)&&void 0!==l?l:"move",this.jumpForce=null!==(c=null==d?void 0:d.jumpForce)&&void 0!==c?c:15,this.groundMoveSpeed=null!==(u=null==d?void 0:d.groundMoveSpeed)&&void 0!==u?u:25,this.floatMoveSpeed=null!==(p=null==d?void 0:d.floatMoveSpeed)&&void 0!==p?p:8,this.rotateSpeed=null!==(m=null==d?void 0:d.rotateSpeed)&&void 0!==m?m:1,this.onKeyDownHandler=this.onKeyDown.bind(this),this.onKeyUpHandler=this.onKeyUp.bind(this),this.onMouseDownHandler=this.onMouseDown.bind(this),this.onMouseMoveHandler=this.onMouseMove.bind(this),this.connect()}get cameraPosOffset(){return this._cameraPositionOffset}set cameraPosOffset(t){this._cameraPositionOffset=t,this.updateCameraInfo()}get cameraLookAtOffset(){return this._cameraLookAtOffset}set cameraLookAtOffset(t){this._cameraLookAtOffset=t,this.updateCameraInfo()}updateCameraInfo(){const t=this._cameraPositionOffset.clone().sub(this._cameraLookAtOffset);this._spherical.setFromVector3(t)}getForwardVector(){return this._objectWorldDirection.copy(this._forwardDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection}getSideVector(){return this._objectWorldDirection.copy(this._forwardDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection.cross(this.object.up),this._objectWorldDirection}updateSync(){return"always"===this.axisSync||"move"===this.axisSync&&(q.forward||q.backward||q.leftward||q.rightward)?(this.camera.getWorldDirection(this._forwardDirection),void this.object.lookAt(this.object.position.clone().add(this.getForwardVector()))):void 0}updateControls(t){const e=t*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed),i=this._accumulatedDirection.set(0,0,0);q.leftward&&i.add(this.getSideVector().multiplyScalar(-1)),q.rightward&&i.add(this.getSideVector()),q.backward&&i.add(this.getForwardVector().multiplyScalar(-1)),q.forward&&i.add(this.getForwardVector()),i.lengthSq()>1e-10&&(i.normalize(),this.velocity.add(i.multiplyScalar(e)),this.object.lookAt(this.object.position.clone().add(i))),q.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce)}updateCamera(){this.object.updateMatrixWorld();const t=this._cameraLookAtPosition.copy(this.object.position).add(this._cameraLookAtOffset);this.camera.position.setFromSpherical(this._spherical).add(t),this.camera.lookAt(t)}update(t){super.update(t),this.updateCamera(),this.updateSync(),this.updateControls(t)}connect(){var t,e;super.connect(),document.addEventListener("keydown",this.onKeyDownHandler),document.addEventListener("keyup",this.onKeyUpHandler),null===(t=this.domElement)||void 0===t||t.addEventListener("mousedown",this.onMouseDownHandler),null===(e=this.domElement)||void 0===e||e.addEventListener("mousemove",this.onMouseMoveHandler)}disconnect(){var t,e;super.disconnect(),document.removeEventListener("keydown",this.onKeyDownHandler),document.removeEventListener("keyup",this.onKeyUpHandler),null===(t=this.domElement)||void 0===t||t.removeEventListener("mousedown",this.onMouseDownHandler),null===(e=this.domElement)||void 0===e||e.removeEventListener("mousemove",this.onMouseMoveHandler)}dispose(){this.disconnect(),super.dispose()}onKeyDown(t){var e,i,o,s,n;(null===(e=this.actionKeys.forward)||void 0===e?void 0:e.some((e=>t.key===e)))&&(q.forward=!0),(null===(i=this.actionKeys.backward)||void 0===i?void 0:i.some((e=>t.key===e)))&&(q.backward=!0),(null===(o=this.actionKeys.leftward)||void 0===o?void 0:o.some((e=>t.key===e)))&&(q.leftward=!0),(null===(s=this.actionKeys.rightward)||void 0===s?void 0:s.some((e=>t.key===e)))&&(q.rightward=!0),(null===(n=this.actionKeys.jump)||void 0===n?void 0:n.some((e=>t.key===e)))&&(q.jump=!0)}onKeyUp(t){var e,i,o,s,n;(null===(e=this.actionKeys.forward)||void 0===e?void 0:e.some((e=>t.key===e)))&&(q.forward=!1),(null===(i=this.actionKeys.backward)||void 0===i?void 0:i.some((e=>t.key===e)))&&(q.backward=!1),(null===(o=this.actionKeys.leftward)||void 0===o?void 0:o.some((e=>t.key===e)))&&(q.leftward=!1),(null===(s=this.actionKeys.rightward)||void 0===s?void 0:s.some((e=>t.key===e)))&&(q.rightward=!1),(null===(n=this.actionKeys.jump)||void 0===n?void 0:n.some((e=>t.key===e)))&&(q.jump=!1)}}const X={forward:!1,backward:!1,leftward:!1,rightward:!1,jump:!1,cameraUp:!1,cameraDown:!1,cameraLeft:!1,cameraRight:!1};class N extends G{constructor(e,i,o,s,n,r,a={},d={}){var l,c,u,p,m;super(e,i,o,a,d),this._objectWorldDirection=new t,this._accumulatedDirection=new t,this._cameraLookAtPosition=new t,this.actionKeys=n,this.camera=s,this._cameraPositionOffset=r.posOffset,this._cameraLookAtOffset=r.lookAtOffset,this._spherical=new h,this.updateCameraInfo(),this.axisSync=null!==(l=r.axisSync)&&void 0!==l?l:"move",this.jumpForce=null!==(c=null==d?void 0:d.jumpForce)&&void 0!==c?c:15,this.groundMoveSpeed=null!==(u=null==d?void 0:d.groundMoveSpeed)&&void 0!==u?u:25,this.floatMoveSpeed=null!==(p=null==d?void 0:d.floatMoveSpeed)&&void 0!==p?p:8,this.rotateSpeed=null!==(m=null==d?void 0:d.rotateSpeed)&&void 0!==m?m:1,this.onKeyDownHandler=this.onKeyDown.bind(this),this.onKeyUpHandler=this.onKeyUp.bind(this),this.connect()}get cameraPosOffset(){return this._cameraPositionOffset}set cameraPosOffset(t){this._cameraPositionOffset=t,this.updateCameraInfo()}get cameraLookAtOffset(){return this._cameraLookAtOffset}set cameraLookAtOffset(t){this._cameraLookAtOffset=t,this.updateCameraInfo()}updateCameraInfo(){const t=this._cameraPositionOffset.clone().sub(this._cameraLookAtOffset);this._spherical.setFromVector3(t)}getForwardVector(){return this.camera.getWorldDirection(this._objectWorldDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection}getSideVector(){return this.camera.getWorldDirection(this._objectWorldDirection),this._objectWorldDirection.y=0,this._objectWorldDirection.normalize(),this._objectWorldDirection.cross(this.object.up),this._objectWorldDirection}updateControls(t){const e=t*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed),i=this._accumulatedDirection.set(0,0,0);X.leftward&&i.add(this.getSideVector().multiplyScalar(-1)),X.rightward&&i.add(this.getSideVector()),X.backward&&i.add(this.getForwardVector().multiplyScalar(-1)),X.forward&&i.add(this.getForwardVector()),i.lengthSq()>1e-10&&(i.normalize(),this.velocity.add(i.multiplyScalar(e)),this.object.lookAt(this.object.position.clone().add(i))),X.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce)}updateCamera(t){const e=this.rotateSpeed*t;X.cameraLeft&&(this._spherical.theta+=e),X.cameraRight&&(this._spherical.theta-=e),X.cameraUp&&(this._spherical.phi=Math.max(.01,this._spherical.phi-e)),X.cameraDown&&(this._spherical.phi=Math.min(Math.PI-.01,this._spherical.phi+e)),this.object.updateMatrixWorld();const i=this._cameraLookAtPosition.copy(this.object.position).add(this._cameraLookAtOffset);this.camera.position.setFromSpherical(this._spherical).add(i),this.camera.lookAt(i)}updateSync(){"always"!==this.axisSync?"move"===this.axisSync&&(X.forward||X.backward||X.leftward||X.rightward)&&this.object.lookAt(this.object.position.clone().add(this.getForwardVector())):this.object.lookAt(this.object.position.clone().add(this.getForwardVector()))}update(t){super.update(t),this.updateCamera(t),this.updateSync(),this.updateControls(t)}onKeyDown(t){for(const[e,i]of Object.entries(this.actionKeys))(null==i?void 0:i.includes(t.key))&&(X[e]=!0)}onKeyUp(t){for(const[e,i]of Object.entries(this.actionKeys))(null==i?void 0:i.includes(t.key))&&(X[e]=!1)}connect(){super.connect(),document.addEventListener("keydown",this.onKeyDownHandler),document.addEventListener("keyup",this.onKeyUpHandler)}disconnect(){super.disconnect(),document.removeEventListener("keydown",this.onKeyDownHandler),document.removeEventListener("keyup",this.onKeyUpHandler)}dispose(){this.disconnect(),super.dispose()}}class Q extends u{constructor(e,i=16777215){super(),this.type="PhysicsControlsHelper",this._capsulePosition=new t,this.controls=e;const o=new p(e.collider.radius,e.collider.height-2*e.collider.radius);if(this.capsuleHelper=new m(o,new v({color:i,toneMapped:!1})),this.capsuleHelper.frustumCulled=!1,this.add(this.capsuleHelper),e.boundary){const t=e.boundary.x.max-e.boundary.x.min,o=e.boundary.y.max-e.boundary.y.min,s=e.boundary.z.max-e.boundary.z.min,n=new y(t,o,s,t,o,s);this.boundaryHelper=new m(n,new v({color:i,toneMapped:!1})),this.boundaryHelper.position.set(e.boundary.x.min+t/2,e.boundary.y.min+o/2,e.boundary.z.min+s/2),this.add(this.boundaryHelper)}this.matrixAutoUpdate=!1,this.update()}update(){this.controls.object.updateMatrixWorld(!0),this.controls.object.getWorldPosition(this._capsulePosition),this._capsulePosition.y+=this.controls.collider.height/2,this.capsuleHelper.position.copy(this._capsulePosition),this.updateMatrix()}dispose(){this.capsuleHelper.geometry.dispose(),this.capsuleHelper.material.dispose(),this.boundaryHelper&&(this.boundaryHelper.geometry.dispose(),this.boundaryHelper.material.dispose()),this.clear()}}export{z as FirstPersonKeyboardControls,I as FirstPersonPointerLockControls,Q as PhysicsControlsHelper,N as ThirdPersonKeyboardControls,R as ThirdPersonMouseDragControls,Y as ThirdPersonPointerLockControls};
