import{Vector3 as t,Plane as e,Line3 as i,Sphere as s,Box3 as n,Triangle as o,Layers as r,Controls as a,AnimationObjectGroup as h,AnimationMixer as l,Group as c,CapsuleGeometry as d,LineSegments as u,LineBasicMaterial as p,BoxGeometry as m}from"three";function y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function f(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,v(s.key),s)}}function b(t,e,i){return e&&f(t.prototype,e),i&&f(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function v(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}var g=function(){function e(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new t(0,0,0),s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t(0,1,0),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;y(this,e),this.start=i,this.end=s,this.radius=n}return b(e,[{key:"clone",value:function(){return new e(this.start.clone(),this.end.clone(),this.radius)}},{key:"set",value:function(t,e,i){this.start.copy(t),this.end.copy(e),this.radius=i}},{key:"copy",value:function(t){this.start.copy(t.start),this.end.copy(t.end),this.radius=t.radius}},{key:"getCenter",value:function(t){return t.copy(this.end).add(this.start).multiplyScalar(.5)}},{key:"translate",value:function(t){this.start.add(t),this.end.add(t)}},{key:"checkAABBAxis",value:function(t,e,i,s,n,o,r,a,h){return(n-t<h||n-i<h)&&(t-o<h||i-o<h)&&(r-e<h||r-s<h)&&(e-a<h||s-a<h)}},{key:"intersectsBox",value:function(t){return this.checkAABBAxis(this.start.x,this.start.y,this.end.x,this.end.y,t.min.x,t.max.x,t.min.y,t.max.y,this.radius)&&this.checkAABBAxis(this.start.x,this.start.z,this.end.x,this.end.z,t.min.x,t.max.x,t.min.z,t.max.z,this.radius)&&this.checkAABBAxis(this.start.y,this.start.z,this.end.y,this.end.z,t.min.y,t.max.y,t.min.z,t.max.z,this.radius)}}])}(),x=new t,w=new t,_=new t,T=new t,k=new e,j=new i,S=new i,A=new s,M=new g,O=new t,z=new t,C=new t;function P(t,e){var i,s,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=O.copy(t.end).sub(t.start),a=z.copy(e.end).sub(e.start),h=C.copy(e.start).sub(t.start),l=r.dot(a),c=r.dot(r),d=a.dot(a),u=a.dot(h),p=r.dot(h),m=c*d-l*l;if(Math.abs(m)<1e-10){var y=-u/d,f=(l-u)/d;Math.abs(y-.5)<Math.abs(f-.5)?(i=0,s=y):(i=1,s=f)}else s=((i=(u*l+p*d)/m)*l-u)/d;s=Math.max(0,Math.min(1,s)),i=Math.max(0,Math.min(1,i)),n&&n.copy(r).multiplyScalar(i).add(t.start),o&&o.copy(a).multiplyScalar(s).add(e.start)}var G=function(){function e(t){y(this,e),this.box=t,this.bounds=new n,this.subTrees=[],this.triangles=[],this.layers=new r}return b(e,[{key:"addTriangle",value:function(t){return this.bounds.min.x=Math.min(this.bounds.min.x,t.a.x,t.b.x,t.c.x),this.bounds.min.y=Math.min(this.bounds.min.y,t.a.y,t.b.y,t.c.y),this.bounds.min.z=Math.min(this.bounds.min.z,t.a.z,t.b.z,t.c.z),this.bounds.max.x=Math.max(this.bounds.max.x,t.a.x,t.b.x,t.c.x),this.bounds.max.y=Math.max(this.bounds.max.y,t.a.y,t.b.y,t.c.y),this.bounds.max.z=Math.max(this.bounds.max.z,t.a.z,t.b.z,t.c.z),this.triangles.push(t),this}},{key:"calcBox",value:function(){return this.box=this.bounds.clone(),this.box.min.x-=.01,this.box.min.y-=.01,this.box.min.z-=.01,this}},{key:"split",value:function(t){if(this.box){for(var i,s=[],o=w.copy(this.box.max).sub(this.box.min).multiplyScalar(.5),r=0;r<2;r++)for(var a=0;a<2;a++)for(var h=0;h<2;h++){var l=new n,c=x.set(r,a,h);l.min.copy(this.box.min).add(c.multiply(o)),l.max.copy(l.min).add(o),s.push(new e(l))}for(;i=this.triangles.pop();)for(var d=0;d<s.length;d++)s[d].box.intersectsTriangle(i)&&s[d].triangles.push(i);for(var u=0;u<s.length;u++){var p=s[u].triangles.length;p>8&&t<16&&s[u].split(t+1),0!==p&&this.subTrees.push(s[u])}return this}}},{key:"build",value:function(){return this.calcBox(),this.split(0),this}},{key:"getRayTriangles",value:function(t,e){for(var i=0;i<this.subTrees.length;i++){var s=this.subTrees[i];if(t.intersectsBox(s.box))if(s.triangles.length>0)for(var n=0;n<s.triangles.length;n++)-1===e.indexOf(s.triangles[n])&&e.push(s.triangles[n]);else s.getRayTriangles(t,e)}return e}},{key:"triangleCapsuleIntersect",value:function(t,e){e.getPlane(k);var i=k.distanceToPoint(t.start)-t.radius,s=k.distanceToPoint(t.end)-t.radius;if(i>0&&s>0||i<-t.radius&&s<-t.radius)return!1;var n=Math.abs(i/(Math.abs(i)+Math.abs(s))),o=x.copy(t.start).lerp(t.end,n);if(e.containsPoint(o))return{normal:k.normal.clone(),point:o.clone(),depth:Math.abs(Math.min(i,s))};for(var r=t.radius*t.radius,a=j.set(t.start,t.end),h=[[e.a,e.b],[e.b,e.c],[e.c,e.a]],l=0;l<h.length;l++){if(P(a,S.set(h[l][0],h[l][1]),_,T),_.distanceToSquared(T)<r)return{normal:_.clone().sub(T).normalize(),point:T.clone(),depth:t.radius-_.distanceTo(T)}}return!1}},{key:"triangleSphereIntersect",value:function(t,e){if(e.getPlane(k),!t.intersectsPlane(k))return!1;var i=Math.abs(k.distanceToSphere(t)),s=t.radius*t.radius-i*i,n=k.projectPoint(t.center,x);if(e.containsPoint(t.center))return{normal:k.normal.clone(),point:n.clone(),depth:Math.abs(k.distanceToSphere(t))};for(var o=[[e.a,e.b],[e.b,e.c],[e.c,e.a]],r=0;r<o.length;r++){j.set(o[r][0],o[r][1]),j.closestPointToPoint(n,!0,w);var a=w.distanceToSquared(t.center);if(a<s)return{normal:t.center.clone().sub(w).normalize(),point:w.clone(),depth:t.radius-Math.sqrt(a)}}return!1}},{key:"getSphereTriangles",value:function(t,e){for(var i=0;i<this.subTrees.length;i++){var s=this.subTrees[i];if(t.intersectsBox(s.box))if(s.triangles.length>0)for(var n=0;n<s.triangles.length;n++)-1===e.indexOf(s.triangles[n])&&e.push(s.triangles[n]);else s.getSphereTriangles(t,e)}}},{key:"getCapsuleTriangles",value:function(t,e){for(var i=0;i<this.subTrees.length;i++){var s=this.subTrees[i];if(t.intersectsBox(s.box))if(s.triangles.length>0)for(var n=0;n<s.triangles.length;n++)-1===e.indexOf(s.triangles[n])&&e.push(s.triangles[n]);else s.getCapsuleTriangles(t,e)}}},{key:"sphereIntersect",value:function(t){A.copy(t);var e,i=[],s=!1;this.getSphereTriangles(t,i);for(var n=0;n<i.length;n++)(e=this.triangleSphereIntersect(A,i[n]))&&(s=!0,A.center.add(e.normal.multiplyScalar(e.depth)));if(s){var o=A.center.clone().sub(t.center),r=o.length();return{normal:o.normalize(),depth:r}}return!1}},{key:"capsuleIntersect",value:function(e){M.copy(e);var i,s=[],n=!1;this.getCapsuleTriangles(M,s);for(var o=0;o<s.length;o++)(i=this.triangleCapsuleIntersect(M,s[o]))&&(n=!0,M.translate(i.normal.multiplyScalar(i.depth)));if(n){var r=M.getCenter(new t).sub(e.getCenter(x)),a=r.length();return{normal:r.normalize(),depth:a}}return!1}},{key:"rayIntersect",value:function(t){if(0!==t.direction.length()){var e,i,s=[],n=1e100;this.getRayTriangles(t,s);for(var o=0;o<s.length;o++){var r=t.intersectTriangle(s[o].a,s[o].b,s[o].c,!0,x);if(r){var a=r.sub(t.origin).length();n>a&&(i=r.clone().add(t.origin),n=a,e=s[o])}}return n<1e100&&{distance:n,triangle:e,position:i}}}},{key:"fromGraphNode",value:function(e){var i=this;return e.updateWorldMatrix(!0,!0),e.traverse((function(e){if(!0===e.isMesh&&i.layers.test(e.layers)){var s,n=!1;null!==e.geometry.index?(n=!0,s=e.geometry.toNonIndexed()):s=e.geometry;for(var r=s.getAttribute("position"),a=0;a<r.count;a+=3){var h=(new t).fromBufferAttribute(r,a),l=(new t).fromBufferAttribute(r,a+1),c=(new t).fromBufferAttribute(r,a+2);h.applyMatrix4(e.matrixWorld),l.applyMatrix4(e.matrixWorld),c.applyMatrix4(e.matrixWorld),i.addTriangle(new o(h,l,c))}n&&s.dispose()}})),this.build(),this}},{key:"clear",value:function(){return this.box=null,this.bounds.makeEmpty(),this.subTrees.length=0,this.triangles.length=0,this}}])}();const B={type:"collide"},E={type:"fall"},I={type:"ground"};class W extends a{constructor(e,i,s,n){super(e,i),this._isGrounded=!1,this.velocity=new t,this.height=(null==n?void 0:n.height)||this.getSize(e).y,this.radius=(null==n?void 0:n.radius)||this.getSize(e).y/4,this.resistance=(null==n?void 0:n.resistance)||4,this._collider=new g(new t(0,this.radius,0),new t(0,this.height-this.radius,0),this.radius),this._collider.translate(e.position),this.gravity=(null==n?void 0:n.gravity)||30,this.maxFallSpeed=(null==n?void 0:n.maxFallSpeed)||60,this.boundary=null==n?void 0:n.boundary,this._worldOctree=new G,this._worldOctree.fromGraphNode(s)}get collider(){return this._collider}get isGrounded(){return this._isGrounded}getSize(e){const i=(new n).setFromObject(e),s=new t;return i.getSize(s),s}checkCollisions(){const t=this._worldOctree.capsuleIntersect(this._collider);this._isGrounded=!1,t&&(this.dispatchEvent(B),t.normal.y>0&&(this.dispatchEvent(I),this._isGrounded=!0),this._isGrounded||(this.velocity.addScaledVector(t.normal,-t.normal.dot(this.velocity)),this.dispatchEvent(E)),t.depth>=1e-10&&this.collider.translate(t.normal.multiplyScalar(t.depth)))}update(t){if(!this.enabled)return;let e=Math.exp(-this.resistance*t)-1;this._isGrounded||(this.velocity.y-=Math.min(this.gravity*t,this.maxFallSpeed),e*=.1),this.velocity.addScaledVector(this.velocity,e);const i=this.velocity.clone().multiplyScalar(t);this._collider.translate(i),this.checkCollisions(),this.teleportPlayerIfOob(),this.object.position.copy(this._collider.end).y-=this.height/2+this.radius}teleportPlayerIfOob(){if(!this.boundary)return;const{resetPoint:t,x:e,y:i,z:s}=this.boundary;(this.object.position.x<e[0]||this.object.position.x>e[1]||this.object.position.y<i[0]||this.object.position.y>i[1]||this.object.position.z<s[0]||this.object.position.z>s[1])&&(this.object.position.copy(t),this._collider.start.set(t.x,t.y+this.radius,t.z),this._collider.end.set(t.x,t.y+this.height-this.radius,t.z),this.velocity.set(0,0,0))}}class F{constructor(t,e){this._animationClips={},this._animationActions={},this.objectGroup=new h(t),this.mixer=new l(this.objectGroup),e&&Object.entries(e).forEach((([t,e])=>{this.setAnimationClip(t,e)}))}get animationClips(){return Object.freeze(Object.assign({},this._animationClips))}addObject(t){this.objectGroup.add(t)}removeObject(t){this.objectGroup.remove(t)}setAnimationClip(t,e){const i=this.mixer.clipAction(e);this._animationClips[t]=e,this._animationActions[t]=i}removeAnimationClip(t){const e=this._animationClips[t];if(!e)return;const i=this._animationActions[t];i&&(i.stop(),this.mixer.uncacheClip(e),this.mixer.uncacheAction(e,this.objectGroup),delete this._animationClips[t],delete this._animationActions[t])}fadeToAction(t,e){const i=this._animationActions[t];i&&(i.isRunning()||(Object.values(this._animationActions).forEach((t=>{t.fadeOut(e)})),i.reset(),i.fadeIn(e),i.play()))}update(t){this.mixer.update(t)}dispose(){this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.objectGroup)}}const L={};class H extends W{constructor(e,i,s,n,o,r,a){super(e,i,s,a),this.camera=null,this.cameraPosOffset=null,this.cameraLookAtOffset=null,this._vector1=new t,this._direction=new t;const{idle:h,forward:l,backward:c,jump:d,fall:u}=r||{};this._characters=new F(e,Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},h&&{idle:h}),l&&{forward:l}),c&&{backward:c}),d&&{jump:d}),u&&{fall:u})),this.keyOptions=n,o&&(this.camera=o.camera,this.cameraPosOffset=o.posOffset,this.cameraLookAtOffset=o.lookAtOffset),this.jumpForce=(null==a?void 0:a.jumpForce)||15,this.groundMoveSpeed=(null==a?void 0:a.groundMoveSpeed)||25,this.floatMoveSpeed=(null==a?void 0:a.floatMoveSpeed)||8,this.rotateSpeed=(null==a?void 0:a.rotateSpeed)||1,this.transitionTime=(null==r?void 0:r.transitionTime)||.3,this.fallSpeedThreshold=(null==r?void 0:r.fallSpeedThreshold)||15,this.moveSpeedThreshold=(null==r?void 0:r.moveSpeedThreshold)||1,this._onKeyDown=D.bind(this),this._onKeyUp=K.bind(this),this.connect()}getForwardVector(){return this.object.getWorldDirection(this._direction),this._direction.y=0,this._direction.normalize(),this._direction}getSideVector(){return this.object.getWorldDirection(this._direction),this._direction.y=0,this._direction.normalize(),this._direction.cross(this.object.up),this._direction}updateControls(t){var e,i,s,n,o;const r=t*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);(null===(e=this.keyOptions.forward)||void 0===e?void 0:e.some((t=>L[t])))&&this.velocity.add(this.getForwardVector().multiplyScalar(r)),(null===(i=this.keyOptions.backward)||void 0===i?void 0:i.some((t=>L[t])))&&this.velocity.add(this.getForwardVector().multiplyScalar(-r)),(null===(s=this.keyOptions.leftTurn)||void 0===s?void 0:s.some((t=>L[t])))&&this.object.rotateY(t*this.rotateSpeed),(null===(n=this.keyOptions.rightTurn)||void 0===n?void 0:n.some((t=>L[t])))&&this.object.rotateY(t*-this.rotateSpeed),this.isGrounded&&(null===(o=this.keyOptions.jump)||void 0===o?void 0:o.some((t=>L[t])))&&(this.velocity.y=this.jumpForce)}updateCamera(){if(this.camera&&this.cameraPosOffset&&this.cameraLookAtOffset){this.object.updateMatrixWorld();const t=this.cameraPosOffset.clone().applyMatrix4(this.object.matrixWorld);this.camera.position.copy(t),this.camera.lookAt(this.object.getWorldPosition(this._vector1).add(this.cameraLookAtOffset))}}updateAnimation(t){this._characters.update(t),this.object.getWorldDirection(this._direction);const e=this._direction.dot(this.velocity);this.isGrounded&&e>this.moveSpeedThreshold?this._characters.fadeToAction("forward",this.transitionTime):this.isGrounded&&e<-this.moveSpeedThreshold?this._characters.fadeToAction("backward",this.transitionTime):this.isGrounded?this._characters.fadeToAction("idle",this.transitionTime):this.velocity.y>0?this._characters.fadeToAction("jump",this.transitionTime):this.velocity.y<-this.fallSpeedThreshold&&this._characters.fadeToAction("fall",this.transitionTime)}update(t){this.updateControls(t),super.update(t),this.updateCamera(),this.updateAnimation(t)}connect(){super.connect(),document.addEventListener("keydown",this._onKeyDown),document.addEventListener("keyup",this._onKeyUp)}disconnect(){super.disconnect(),document.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("keyup",this._onKeyUp)}}function D(t){L[t.key]=!0}function K(t){L[t.key]=!1}class V extends c{constructor(e,i=16777215){super(),this.type="PhysicsControlsHelper",this._position=new t;const s=new d(e.radius,e.height-2*e.radius);if(this.capsuleHelper=new u(s,new p({color:i,toneMapped:!1})),this.add(this.capsuleHelper),e.boundary){const t=e.boundary.x[1]-e.boundary.x[0],s=e.boundary.y[1]-e.boundary.y[0],n=e.boundary.z[1]-e.boundary.z[0],o=new m(t,s,n,t,s,n);this.boundaryHelper=new u(o,new p({color:i,toneMapped:!1})),this.add(this.boundaryHelper)}this.controls=e,this.matrixAutoUpdate=!1,this.update()}update(){this.controls.object.updateMatrixWorld(!0),this._position.copy(this.controls.object.position),this._position.y+=this.controls.height/2,this.capsuleHelper.position.copy(this._position),this.capsuleHelper.rotation.copy(this.controls.object.rotation),this.updateMatrix()}}export{H as KeyboardRotationControls,V as PhysicsControlsHelper};
