import{Vector3 as e,Plane as t,Line3 as i,Sphere as o,Box3 as n,Triangle as s,Layers as a,Controls as r,Ray as c,PerspectiveCamera as l,OrthographicCamera as d,Quaternion as h,AnimationObjectGroup as u,AnimationMixer as m,LoopOnce as p,Spherical as v,Group as _,CapsuleGeometry as w,LineSegments as y,LineBasicMaterial as b,BoxGeometry as f}from"three";function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function D(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,j(o.key),o)}}function M(e,t,i){return t&&D(e.prototype,t),i&&D(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function j(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var o=i.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}var S=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e(0,0,0),o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e(0,1,0),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;g(this,t),this.start=i,this.end=o,this.radius=n}return M(t,[{key:"clone",value:function(){return new t(this.start.clone(),this.end.clone(),this.radius)}},{key:"set",value:function(e,t,i){this.start.copy(e),this.end.copy(t),this.radius=i}},{key:"copy",value:function(e){this.start.copy(e.start),this.end.copy(e.end),this.radius=e.radius}},{key:"getCenter",value:function(e){return e.copy(this.end).add(this.start).multiplyScalar(.5)}},{key:"translate",value:function(e){this.start.add(e),this.end.add(e)}},{key:"checkAABBAxis",value:function(e,t,i,o,n,s,a,r,c){return(n-e<c||n-i<c)&&(e-s<c||i-s<c)&&(a-t<c||a-o<c)&&(t-r<c||o-r<c)}},{key:"intersectsBox",value:function(e){return this.checkAABBAxis(this.start.x,this.start.y,this.end.x,this.end.y,e.min.x,e.max.x,e.min.y,e.max.y,this.radius)&&this.checkAABBAxis(this.start.x,this.start.z,this.end.x,this.end.z,e.min.x,e.max.x,e.min.z,e.max.z,this.radius)&&this.checkAABBAxis(this.start.y,this.start.z,this.end.y,this.end.z,e.min.y,e.max.y,e.min.z,e.max.z,this.radius)}}])}(),L=new e,x=new e,k=new e,A=new e,O=new t,E=new i,K=new i,z=new o,F=new S,T=new e,V=new e,W=new e;function P(e,t){var i,o,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=T.copy(e.end).sub(e.start),r=V.copy(t.end).sub(t.start),c=W.copy(t.start).sub(e.start),l=a.dot(r),d=a.dot(a),h=r.dot(r),u=r.dot(c),m=a.dot(c),p=d*h-l*l;if(Math.abs(p)<1e-10){var v=-u/h,_=(l-u)/h;Math.abs(v-.5)<Math.abs(_-.5)?(i=0,o=v):(i=1,o=_)}else o=((i=(u*l+m*h)/p)*l-u)/h;o=Math.max(0,Math.min(1,o)),i=Math.max(0,Math.min(1,i)),n&&n.copy(a).multiplyScalar(i).add(e.start),s&&s.copy(r).multiplyScalar(o).add(t.start)}var C=function(){function t(e){g(this,t),this.box=e,this.bounds=new n,this.subTrees=[],this.triangles=[],this.layers=new a}return M(t,[{key:"addTriangle",value:function(e){return this.bounds.min.x=Math.min(this.bounds.min.x,e.a.x,e.b.x,e.c.x),this.bounds.min.y=Math.min(this.bounds.min.y,e.a.y,e.b.y,e.c.y),this.bounds.min.z=Math.min(this.bounds.min.z,e.a.z,e.b.z,e.c.z),this.bounds.max.x=Math.max(this.bounds.max.x,e.a.x,e.b.x,e.c.x),this.bounds.max.y=Math.max(this.bounds.max.y,e.a.y,e.b.y,e.c.y),this.bounds.max.z=Math.max(this.bounds.max.z,e.a.z,e.b.z,e.c.z),this.triangles.push(e),this}},{key:"calcBox",value:function(){return this.box=this.bounds.clone(),this.box.min.x-=.01,this.box.min.y-=.01,this.box.min.z-=.01,this}},{key:"split",value:function(e){if(this.box){for(var i,o=[],s=x.copy(this.box.max).sub(this.box.min).multiplyScalar(.5),a=0;a<2;a++)for(var r=0;r<2;r++)for(var c=0;c<2;c++){var l=new n,d=L.set(a,r,c);l.min.copy(this.box.min).add(d.multiply(s)),l.max.copy(l.min).add(s),o.push(new t(l))}for(;i=this.triangles.pop();)for(var h=0;h<o.length;h++)o[h].box.intersectsTriangle(i)&&o[h].triangles.push(i);for(var u=0;u<o.length;u++){var m=o[u].triangles.length;m>8&&e<16&&o[u].split(e+1),0!==m&&this.subTrees.push(o[u])}return this}}},{key:"build",value:function(){return this.calcBox(),this.split(0),this}},{key:"getRayTriangles",value:function(e,t){for(var i=0;i<this.subTrees.length;i++){var o=this.subTrees[i];if(e.intersectsBox(o.box))if(o.triangles.length>0)for(var n=0;n<o.triangles.length;n++)-1===t.indexOf(o.triangles[n])&&t.push(o.triangles[n]);else o.getRayTriangles(e,t)}return t}},{key:"triangleCapsuleIntersect",value:function(e,t){t.getPlane(O);var i=O.distanceToPoint(e.start)-e.radius,o=O.distanceToPoint(e.end)-e.radius;if(i>0&&o>0||i<-e.radius&&o<-e.radius)return!1;var n=Math.abs(i/(Math.abs(i)+Math.abs(o))),s=L.copy(e.start).lerp(e.end,n);if(t.containsPoint(s))return{normal:O.normal.clone(),point:s.clone(),depth:Math.abs(Math.min(i,o))};for(var a=e.radius*e.radius,r=E.set(e.start,e.end),c=[[t.a,t.b],[t.b,t.c],[t.c,t.a]],l=0;l<c.length;l++){if(P(r,K.set(c[l][0],c[l][1]),k,A),k.distanceToSquared(A)<a)return{normal:k.clone().sub(A).normalize(),point:A.clone(),depth:e.radius-k.distanceTo(A)}}return!1}},{key:"triangleSphereIntersect",value:function(e,t){if(t.getPlane(O),!e.intersectsPlane(O))return!1;var i=Math.abs(O.distanceToSphere(e)),o=e.radius*e.radius-i*i,n=O.projectPoint(e.center,L);if(t.containsPoint(e.center))return{normal:O.normal.clone(),point:n.clone(),depth:Math.abs(O.distanceToSphere(e))};for(var s=[[t.a,t.b],[t.b,t.c],[t.c,t.a]],a=0;a<s.length;a++){E.set(s[a][0],s[a][1]),E.closestPointToPoint(n,!0,x);var r=x.distanceToSquared(e.center);if(r<o)return{normal:e.center.clone().sub(x).normalize(),point:x.clone(),depth:e.radius-Math.sqrt(r)}}return!1}},{key:"getSphereTriangles",value:function(e,t){for(var i=0;i<this.subTrees.length;i++){var o=this.subTrees[i];if(e.intersectsBox(o.box))if(o.triangles.length>0)for(var n=0;n<o.triangles.length;n++)-1===t.indexOf(o.triangles[n])&&t.push(o.triangles[n]);else o.getSphereTriangles(e,t)}}},{key:"getCapsuleTriangles",value:function(e,t){for(var i=0;i<this.subTrees.length;i++){var o=this.subTrees[i];if(e.intersectsBox(o.box))if(o.triangles.length>0)for(var n=0;n<o.triangles.length;n++)-1===t.indexOf(o.triangles[n])&&t.push(o.triangles[n]);else o.getCapsuleTriangles(e,t)}}},{key:"sphereIntersect",value:function(e){z.copy(e);var t,i=[],o=!1;this.getSphereTriangles(e,i);for(var n=0;n<i.length;n++)(t=this.triangleSphereIntersect(z,i[n]))&&(o=!0,z.center.add(t.normal.multiplyScalar(t.depth)));if(o){var s=z.center.clone().sub(e.center),a=s.length();return{normal:s.normalize(),depth:a}}return!1}},{key:"capsuleIntersect",value:function(t){F.copy(t);var i,o=[],n=!1;this.getCapsuleTriangles(F,o);for(var s=0;s<o.length;s++)(i=this.triangleCapsuleIntersect(F,o[s]))&&(n=!0,F.translate(i.normal.multiplyScalar(i.depth)));if(n){var a=F.getCenter(new e).sub(t.getCenter(L)),r=a.length();return{normal:a.normalize(),depth:r}}return!1}},{key:"rayIntersect",value:function(e){if(0!==e.direction.length()){var t,i,o=[],n=1e100;this.getRayTriangles(e,o);for(var s=0;s<o.length;s++){var a=e.intersectTriangle(o[s].a,o[s].b,o[s].c,!0,L);if(a){var r=a.sub(e.origin).length();n>r&&(i=a.clone().add(e.origin),n=r,t=o[s])}}return n<1e100&&{distance:n,triangle:t,position:i}}}},{key:"fromGraphNode",value:function(t){var i=this;return t.updateWorldMatrix(!0,!0),t.traverse((function(t){if(!0===t.isMesh&&i.layers.test(t.layers)){var o,n=!1;null!==t.geometry.index?(n=!0,o=t.geometry.toNonIndexed()):o=t.geometry;for(var a=o.getAttribute("position"),r=0;r<a.count;r+=3){var c=(new e).fromBufferAttribute(a,r),l=(new e).fromBufferAttribute(a,r+1),d=(new e).fromBufferAttribute(a,r+2);c.applyMatrix4(t.matrixWorld),l.applyMatrix4(t.matrixWorld),d.applyMatrix4(t.matrixWorld),i.addTriangle(new s(c,l,d))}n&&o.dispose()}})),this.build(),this}},{key:"clear",value:function(){return this.box=null,this.bounds.makeEmpty(),this.subTrees.length=0,this.triangles.length=0,this}}])}();class U extends S{constructor(e,t,i){super(e,t,i)}get height(){return this.start.distanceTo(this.end)+2*this.radius}}const R={type:"collide"};class G extends r{constructor(t,i,o,s){var a,r,l,d,h;super(t,i),this._ray=new c(new e,new e(0,-1,0)),this.velocity=new e,this._isGrounded=!1,this._isLanding=!1,this._deltaVelocity=new e,this._worldOctree=new C,this._worldOctree.fromGraphNode(o);const u=new e;(new n).setFromObject(this.object).getSize(u);const m=(null==s?void 0:s.colliderRadius)||u.y/4,p=(null==s?void 0:s.colliderHeight)||u.y;this._capsuleCollider=new U(new e(0,m,0),new e(0,p-m,0),m),this._capsuleCollider.translate(t.position),this.step=null!==(a=null==s?void 0:s.step)&&void 0!==a?a:5,this.gravity=null!==(r=null==s?void 0:s.gravity)&&void 0!==r?r:30,this.maxFallSpeed=null!==(l=null==s?void 0:s.maxFallSpeed)&&void 0!==l?l:20,this.movementResistance=null!==(d=null==s?void 0:s.movementResistance)&&void 0!==d?d:6,this.landTimeThreshold=null!==(h=null==s?void 0:s.landTimeThreshold)&&void 0!==h?h:250,this.boundary=null==s?void 0:s.boundary}get isGrounded(){return this._isGrounded}get isLanding(){return this._isLanding}get collider(){return this._capsuleCollider}_checkCollisions(){this._isGrounded=!1;const e=this._worldOctree.capsuleIntersect(this.collider);e&&(e.normal.y>0&&(this._isGrounded=!0),e.depth>=1e-10&&(this.collider.translate(e.normal.multiplyScalar(e.depth)),this.dispatchEvent(Object.assign(Object.assign({},R),{normal:e.normal.normalize()}))))}_checkLanding(){if(this._isLanding=!1,this._isGrounded||this.velocity.y>=0)return;this._ray.origin.copy(this._capsuleCollider.start).y-=this._capsuleCollider.radius;this._worldOctree.rayIntersect(this._ray).distance/-this._deltaVelocity.y<this.landTimeThreshold&&(this._isLanding=!0)}_teleportPlayerIfOutOfBounds(){if(!this.boundary)return;const{resetPoint:e,x:t,y:i,z:o}=this.boundary,{x:n,y:s,z:a}=this.object.position;(n<t.min||n>t.max||s<i.min||s>i.max||a<o.min||a>o.max)&&(this.collider.end.set(e.x,e.y+this.collider.height-this.collider.radius,e.z),this.collider.start.set(e.x,e.y+this.collider.radius,e.z),this.velocity.set(0,0,0))}update(e){if(!this.enabled)return;super.update(e);const t=e/this.step;for(let e=0;e<this.step;e++){let e=Math.exp(-this.movementResistance*t)-1;this._isGrounded||(this.velocity.y-=this.gravity*t,this.velocity.y=Math.max(this.velocity.y,-this.maxFallSpeed),e*=.1),this.velocity.addScaledVector(this.velocity,e),this._deltaVelocity.copy(this.velocity).multiplyScalar(t),this.collider.translate(this._deltaVelocity),this._checkCollisions(),this._checkLanding(),this._teleportPlayerIfOutOfBounds()}this.object.position.copy(this.collider.start),this.object.position.y-=this.collider.radius}connect(){super.connect()}disconnect(){super.disconnect()}dispose(){super.dispose()}}const Y={forward:0,backward:0,leftward:0,rightward:0,turnUp:0,turnDown:0,turnLeft:0,turnRight:0,jump:0,accelerate:0},I={forward:["KeyW"],backward:["KeyS"],leftward:["KeyA"],rightward:["KeyD"],jump:["Space"],turnUp:["ArrowUp"],turnDown:["ArrowDown"],turnLeft:["ArrowLeft"],turnRight:["ArrowRight"],accelerate:["ShiftLeft"]};class H extends G{constructor({object:t,domElement:i,worldObject:o,actionKeys:n,cameraOptions:s,physicsOptions:a}){var r,c,h,u,m,p,v,_,w,y;super(t,i,o,Object.assign({colliderHeight:1.6,colliderRadius:.5},a)),this._keyCount=0,this._objectLocalDirection=new e,this._accumulatedDirection=new e,this._worldYDirection=new e(0,1,0),this._onMouseWheel=e=>{if(!this.enableZoom)return;if(!(this.object instanceof l||this.object instanceof d))return console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),void(this.enableZoom=!1);const t=Math.pow(.95,this.zoomSpeed*Math.abs(.01*e.deltaY));e.deltaY>0?this.object.zoom*=t:e.deltaY<0&&(this.object.zoom/=t),this.object.updateProjectionMatrix()},this.actionKeys=null!=n?n:I,this.enableZoom=null===(r=null==s?void 0:s.enableZoom)||void 0===r||r,this.zoomSpeed=null!==(c=null==s?void 0:s.zoomSpeed)&&void 0!==c?c:1,this.eyeHeight=null!==(h=null==a?void 0:a.eyeHeight)&&void 0!==h?h:1.5,this.jumpForce=null!==(u=null==a?void 0:a.jumpForce)&&void 0!==u?u:15,this.groundMoveSpeed=null!==(m=null==a?void 0:a.groundMoveSpeed)&&void 0!==m?m:30,this.floatMoveSpeed=null!==(p=null==a?void 0:a.floatMoveSpeed)&&void 0!==p?p:8,this.rotateSpeed=null!==(v=null==a?void 0:a.rotateSpeed)&&void 0!==v?v:1,this.enableDiagonalMovement=null===(_=null==a?void 0:a.enableDiagonalMovement)||void 0===_||_,this.enableAcceleration=null===(w=null==a?void 0:a.enableAcceleration)||void 0===w||w,this.accelerationFactor=null!==(y=null==a?void 0:a.accelerationFactor)&&void 0!==y?y:1.5,this.onKeyDown=this._onKeyDown.bind(this),this.onKeyUp=this._onKeyUp.bind(this),this.onMouseWheel=this._onMouseWheel.bind(this),this.connect()}_getForwardVector(){return this.object.getWorldDirection(this._objectLocalDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection}_getSideVector(){return this.object.getWorldDirection(this._objectLocalDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection.cross(this.object.up),this._objectLocalDirection}_accumulateDirection(){return this._accumulatedDirection.set(0,0,0),Y.forward&&this._accumulatedDirection.add(this._getForwardVector()),Y.backward&&this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)),Y.leftward&&this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)),Y.rightward&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection.normalize()}_getMostRecentDirection(){this._accumulatedDirection.set(0,0,0);let e=null,t=0;return Object.entries(Y).forEach((([i,o])=>{o>t&&(e=i,t=o)})),"forward"===e?this._accumulatedDirection.add(this._getForwardVector()):"backward"===e?this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)):"leftward"===e?this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)):"rightward"===e&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection}updateControls(e){let t,i=e*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);this.enableAcceleration&&Y.accelerate&&(i*=this.accelerationFactor),t=this.enableDiagonalMovement?this._accumulateDirection():this._getMostRecentDirection(),this.velocity.add(t.multiplyScalar(i)),Y.turnLeft&&this.object.rotateOnWorldAxis(this._worldYDirection,this.rotateSpeed*e),Y.turnRight&&this.object.rotateOnWorldAxis(this._worldYDirection,-this.rotateSpeed*e),Y.turnUp&&this.object.rotateX(this.rotateSpeed*e),Y.turnDown&&this.object.rotateX(-this.rotateSpeed*e),this.object.rotation.x=Math.min(Math.max(this.object.rotation.x,-Math.PI/2),Math.PI/2),Y.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce),this.object.updateMatrixWorld()}update(e){super.update(e),this.object.position.y+=this.eyeHeight,this.updateControls(e)}connect(){var e;super.connect(),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.addEventListener("wheel",this.onMouseWheel)}disconnect(){var e;super.disconnect(),document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.removeEventListener("wheel",this.onMouseWheel)}dispose(){this.disconnect(),super.dispose()}_onKeyDown(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){Y[t]=++this._keyCount;break}}_onKeyUp(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){Y[t]=0;break}}}const Z={forward:0,backward:0,leftward:0,rightward:0,jump:0,accelerate:0},B={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],leftward:["KeyA","ArrowLeft"],rightward:["KeyD","ArrowRight"],jump:["Space"],accelerate:["ShiftLeft"]};class N extends G{constructor({object:t,domElement:i,worldObject:o,actionKeys:n,cameraOptions:s,physicsOptions:a}){var r,c,h,u,m,p,v,_,w,y;super(t,i,o,Object.assign({colliderHeight:1.6,colliderRadius:.5},a)),this._keyCount=0,this._isMouseDown=!1,this._objectLocalDirection=new e,this._accumulatedDirection=new e,this._worldYDirection=new e(0,1,0),this._onMouseDown=()=>{this._isMouseDown=!0},this._onMouseUp=()=>{this._isMouseDown=!1},this._onMouseMove=e=>{this._isMouseDown&&(this.object.rotateOnWorldAxis(this._worldYDirection,-1*e.movementX*this.rotateSpeed/100),this.object.rotateX(-1*e.movementY*this.rotateSpeed/100),this.object.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.object.rotation.x)))},this._onMouseWheel=e=>{if(!this.enableZoom)return;if(!(this.object instanceof l||this.object instanceof d))return console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),void(this.enableZoom=!1);const t=Math.pow(.95,this.zoomSpeed*Math.abs(.01*e.deltaY));e.deltaY>0?this.object.zoom*=t:e.deltaY<0&&(this.object.zoom/=t),this.object.updateProjectionMatrix()},this.actionKeys=null!=n?n:B,this.enableZoom=null===(r=null==s?void 0:s.enableZoom)||void 0===r||r,this.zoomSpeed=null!==(c=null==s?void 0:s.zoomSpeed)&&void 0!==c?c:1,this.eyeHeight=null!==(h=null==a?void 0:a.eyeHeight)&&void 0!==h?h:1.5,this.jumpForce=null!==(u=null==a?void 0:a.jumpForce)&&void 0!==u?u:15,this.groundMoveSpeed=null!==(m=null==a?void 0:a.groundMoveSpeed)&&void 0!==m?m:30,this.floatMoveSpeed=null!==(p=null==a?void 0:a.floatMoveSpeed)&&void 0!==p?p:8,this.rotateSpeed=null!==(v=null==a?void 0:a.rotateSpeed)&&void 0!==v?v:.5,this.enableDiagonalMovement=null===(_=null==a?void 0:a.enableDiagonalMovement)||void 0===_||_,this.enableAcceleration=null===(w=null==a?void 0:a.enableAcceleration)||void 0===w||w,this.accelerationFactor=null!==(y=null==a?void 0:a.accelerationFactor)&&void 0!==y?y:1.5,this.onKeyDown=this._onKeyDown.bind(this),this.onKeyUp=this._onKeyUp.bind(this),this.onMouseDown=this._onMouseDown.bind(this),this.onMouseUp=this._onMouseUp.bind(this),this.onMouseMove=this._onMouseMove.bind(this),this.onMouseWheel=this._onMouseWheel.bind(this),this.connect()}_getForwardVector(){return this.object.getWorldDirection(this._objectLocalDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection}_getSideVector(){return this.object.getWorldDirection(this._objectLocalDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection.cross(this.object.up),this._objectLocalDirection}_accumulateDirection(){return this._accumulatedDirection.set(0,0,0),Z.forward&&this._accumulatedDirection.add(this._getForwardVector()),Z.backward&&this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)),Z.leftward&&this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)),Z.rightward&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection.normalize()}_getMostRecentDirection(){this._accumulatedDirection.set(0,0,0);let e=null,t=0;return Object.entries(Z).forEach((([i,o])=>{o>t&&(e=i,t=o)})),"forward"===e?this._accumulatedDirection.add(this._getForwardVector()):"backward"===e?this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)):"leftward"===e?this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)):"rightward"===e&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection}updateControls(e){let t,i=e*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);this.enableAcceleration&&Z.accelerate&&(i*=this.accelerationFactor),t=this.enableDiagonalMovement?this._accumulateDirection():this._getMostRecentDirection(),this.velocity.add(t.multiplyScalar(i)),Z.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce),this.object.updateMatrixWorld()}update(e){super.update(e),this.object.position.y+=this.eyeHeight,this.updateControls(e)}connect(){var e,t,i;super.connect(),window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.addEventListener("mousedown",this.onMouseDown),document.addEventListener("mouseup",this.onMouseUp),null===(t=this.domElement)||void 0===t||t.addEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.removeEventListener("wheel",this.onMouseWheel)}disconnect(){var e,t,i;super.disconnect(),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mouseup",this.onMouseUp),null===(t=this.domElement)||void 0===t||t.removeEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.removeEventListener("wheel",this.onMouseWheel)}dispose(){this.disconnect(),super.dispose()}_onKeyDown(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){Z[t]=++this._keyCount;break}}_onKeyUp(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){Z[t]=0;break}}}const q={forward:0,backward:0,leftward:0,rightward:0,jump:0,accelerate:0},X={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],leftward:["KeyA","ArrowLeft"],rightward:["KeyD","ArrowRight"],jump:["Space"],accelerate:["ShiftLeft"]};class Q extends G{constructor({object:t,domElement:i,worldObject:o,actionKeys:n,cameraOptions:s,physicsOptions:a}){var r,c,h,u,m,p,v,_,w,y;super(t,i,o,Object.assign({colliderHeight:1.6,colliderRadius:.5},a)),this._keyCount=0,this._objectLocalDirection=new e,this._accumulatedDirection=new e,this._worldYDirection=new e(0,1,0),this._onMouseWheel=e=>{if(!this.enableZoom)return;if(!(this.object instanceof l||this.object instanceof d))return console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),void(this.enableZoom=!1);const t=Math.pow(.95,this.zoomSpeed*Math.abs(.01*e.deltaY));e.deltaY>0?this.object.zoom*=t:e.deltaY<0&&(this.object.zoom/=t),this.object.updateProjectionMatrix()},this.actionKeys=null!=n?n:X,this.enableZoom=null===(r=null==s?void 0:s.enableZoom)||void 0===r||r,this.zoomSpeed=null!==(c=null==s?void 0:s.zoomSpeed)&&void 0!==c?c:1,this.eyeHeight=null!==(h=null==a?void 0:a.eyeHeight)&&void 0!==h?h:1.5,this.jumpForce=null!==(u=null==a?void 0:a.jumpForce)&&void 0!==u?u:15,this.groundMoveSpeed=null!==(m=null==a?void 0:a.groundMoveSpeed)&&void 0!==m?m:30,this.floatMoveSpeed=null!==(p=null==a?void 0:a.floatMoveSpeed)&&void 0!==p?p:8,this.rotateSpeed=null!==(v=null==a?void 0:a.rotateSpeed)&&void 0!==v?v:.2,this.enableDiagonalMovement=null===(_=null==a?void 0:a.enableDiagonalMovement)||void 0===_||_,this.enableAcceleration=null===(w=null==a?void 0:a.enableAcceleration)||void 0===w||w,this.accelerationFactor=null!==(y=null==a?void 0:a.accelerationFactor)&&void 0!==y?y:1.5,this.onKeyDown=this._onKeyDown.bind(this),this.onKeyUp=this._onKeyUp.bind(this),this.onMouseMove=this._onMouseMove.bind(this),this.onMouseDown=this._onMouseDown.bind(this),this.onMouseWheel=this._onMouseWheel.bind(this),this.connect()}_getForwardVector(){return this.object.getWorldDirection(this._objectLocalDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection}_getSideVector(){return this.object.getWorldDirection(this._objectLocalDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection.cross(this.object.up),this._objectLocalDirection}_accumulateDirection(){return this._accumulatedDirection.set(0,0,0),q.forward&&this._accumulatedDirection.add(this._getForwardVector()),q.backward&&this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)),q.leftward&&this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)),q.rightward&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection.normalize()}_getMostRecentDirection(){this._accumulatedDirection.set(0,0,0);let e=null,t=0;return Object.entries(q).forEach((([i,o])=>{o>t&&(e=i,t=o)})),"forward"===e?this._accumulatedDirection.add(this._getForwardVector()):"backward"===e?this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)):"leftward"===e?this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)):"rightward"===e&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection}updateControls(e){let t,i=e*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);this.enableAcceleration&&q.accelerate&&(i*=this.accelerationFactor),t=this.enableDiagonalMovement?this._accumulateDirection():this._getMostRecentDirection(),this.velocity.add(t.multiplyScalar(i)),q.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce),this.object.updateMatrixWorld()}update(e){super.update(e),this.object.position.y+=this.eyeHeight,this.updateControls(e)}connect(){var e,t,i;super.connect(),window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.addEventListener("click",this.onMouseDown),null===(t=this.domElement)||void 0===t||t.addEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.addEventListener("wheel",this.onMouseWheel)}disconnect(){var e,t,i;super.disconnect(),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.removeEventListener("click",this.onMouseDown),null===(t=this.domElement)||void 0===t||t.removeEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.removeEventListener("wheel",this.onMouseWheel)}dispose(){this.disconnect(),super.dispose()}_onKeyDown(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){q[t]=++this._keyCount;break}}_onKeyUp(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){q[t]=0;break}}_onMouseDown(){var e;null===(e=this.domElement)||void 0===e||e.requestPointerLock()}_onMouseMove(e){document.pointerLockElement===this.domElement&&(this.object.rotateOnWorldAxis(this._worldYDirection,-1*e.movementX*this.rotateSpeed/100),this.object.rotateX(-1*e.movementY*this.rotateSpeed/100),this.object.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.object.rotation.x)))}}class J extends G{constructor(t,i,o,n={},s={}){var a,r,c,l,d;super(t,i,o,s),this._animationClips={},this._animationActions={},this._localVelocity=new e,this._worldQuaternion=new h,this._currentAction=null,this._objectGroup=new u(t),this._mixer=new m(this._objectGroup),n.animationClips&&Object.entries(n.animationClips).forEach((([e,t])=>{this.setAnimationClip(e,t)})),this.transitionTime=null!==(a=n.transitionTime)&&void 0!==a?a:.3,this.transitionDelay=null!==(r=n.transitionDelay)&&void 0!==r?r:.3,this.fallSpeedThreshold=null!==(c=n.fallSpeedThreshold)&&void 0!==c?c:15,this.moveSpeedThreshold=null!==(l=n.moveSpeedThreshold)&&void 0!==l?l:1,this.runSpeedThreshold=null!==(d=n.runSpeedThreshold)&&void 0!==d?d:5}get clips(){return Object.freeze(Object.assign({},this._animationClips))}addObject(e){this._objectGroup.add(e)}removeObject(e){this._objectGroup.remove(e)}setAnimationClip(e,t){const i=this._mixer.clipAction(t);this._animationClips[e]=t,this._animationActions[e]=i}removeAnimationClip(e){const t=this._animationClips[e];if(!t)return;const i=this._animationActions[e];i&&(i.stop(),this._mixer.uncacheAction(t,this._objectGroup)),this._mixer.uncacheClip(t),delete this._animationClips[e],delete this._animationActions[e]}_fadeToAction(e,t,i){const o=this._animationActions[e];o&&o!==this._currentAction&&(Object.values(this._animationActions).forEach((e=>{e.fadeOut(t)})),this._currentAction=o,o.reset(),i&&(o.setLoop(p,1),o.clampWhenFinished=!0),o.fadeIn(t),o.play())}_updateAnimation(){const e=this.object.getWorldQuaternion(this._worldQuaternion);return this._localVelocity.copy(this.velocity).applyQuaternion(e.invert()),this.velocity.y>0?this._fadeToAction("jumpUp",this.transitionTime,!0):this.isLanding?this._fadeToAction("jumpDown",this.transitionTime,!0):this.isGrounded&&this._localVelocity.z>this.runSpeedThreshold&&this._animationActions.runForward?this._fadeToAction("runForward",this.transitionTime):this.isGrounded&&this._localVelocity.z>this.moveSpeedThreshold?this._fadeToAction("forward",this.transitionTime):this.isGrounded&&this._localVelocity.z<-this.runSpeedThreshold&&this._animationActions.runBackward?this._fadeToAction("runBackward",this.transitionTime):this.isGrounded&&this._localVelocity.z<-this.moveSpeedThreshold?this._fadeToAction("backward",this.transitionTime):this.isGrounded&&this._localVelocity.x>this.runSpeedThreshold&&this._animationActions.runLeftward?this._fadeToAction("runLeftward",this.transitionTime):this.isGrounded&&this._localVelocity.x>this.moveSpeedThreshold?this._fadeToAction("leftward",this.transitionTime):this.isGrounded&&this._localVelocity.x<-this.runSpeedThreshold&&this._animationActions.runRightward?this._fadeToAction("runRightward",this.transitionTime):this.isGrounded&&this._localVelocity.x<-this.moveSpeedThreshold?this._fadeToAction("rightward",this.transitionTime):!this.isLanding&&this.velocity.y<-this.fallSpeedThreshold?this._fadeToAction("fall",this.transitionTime):this.isGrounded?this._fadeToAction("idle",this.transitionTime):void 0}update(e){super.update(e),this._updateAnimation(),this._mixer.update(e)}dispose(){this._mixer.stopAllAction(),this._mixer.uncacheRoot(this._objectGroup)}}const $={forward:0,backward:0,leftward:0,rightward:0,jump:0,accelerate:0},ee={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],leftward:["KeyA","ArrowLeft"],rightward:["KeyD","ArrowRight"],jump:["Space"],accelerate:["ShiftLeft"]};class te extends J{constructor({object:t,domElement:i,worldObject:o,camera:n,actionKeys:s,cameraOptions:a,animationOptions:r,physicsOptions:c}){var h,u,m,p,_,w,y,b,f,g,D,M,j,S;super(t,i,o,r,c),this._spherical=new v,this._isMouseDown=!1,this._keyCount=0,this._forwardDirection=new e,this._objectLocalDirection=new e,this._accumulatedDirection=new e,this._cameraLookAtPosition=new e,this._cameraLerpPosition=new e,this._onMouseDown=()=>{this._isMouseDown=!0},this._onMouseUp=()=>{this._isMouseDown=!1},this._onMouseMove=e=>{this._isMouseDown&&(this._spherical.theta-=e.movementX*this.rotateSpeed/100,this._spherical.phi-=e.movementY*this.rotateSpeed/100,this._spherical.phi=Math.max(.01,Math.min(Math.PI-.01,this._spherical.phi)))},this._onMouseWheel=e=>{if(!this.enableZoom)return;if(!(this.camera instanceof l||this.camera instanceof d))return console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),void(this.enableZoom=!1);const t=Math.pow(.95,this.zoomSpeed*Math.abs(.01*e.deltaY));e.deltaY>0?this.camera.zoom*=t:e.deltaY<0&&(this.camera.zoom/=t),this.camera.updateProjectionMatrix()},this.actionKeys=null!=s?s:ee,this.camera=n,this.cameraPositionOffset=null!==(h=null==a?void 0:a.posOffset)&&void 0!==h?h:new e(0,2,-2),this.cameraLookAtOffset=null!==(u=null==a?void 0:a.lookAtOffset)&&void 0!==u?u:new e(0,1,0),this.cameraLerpFactor=null!==(m=null==a?void 0:a.cameraLerpFactor)&&void 0!==m?m:1;const L=this.cameraPositionOffset.clone().sub(this.cameraLookAtOffset);this._spherical.setFromVector3(L),this.axisSync=null!==(p=null==a?void 0:a.axisSync)&&void 0!==p?p:"move",this.enableZoom=null===(_=null==a?void 0:a.enableZoom)||void 0===_||_,this.zoomSpeed=null!==(w=null==a?void 0:a.zoomSpeed)&&void 0!==w?w:1,this.jumpForce=null!==(y=null==c?void 0:c.jumpForce)&&void 0!==y?y:15,this.groundMoveSpeed=null!==(b=null==c?void 0:c.groundMoveSpeed)&&void 0!==b?b:30,this.floatMoveSpeed=null!==(f=null==c?void 0:c.floatMoveSpeed)&&void 0!==f?f:8,this.rotateSpeed=null!==(g=null==c?void 0:c.rotateSpeed)&&void 0!==g?g:1,this.enableDiagonalMovement=null===(D=null==c?void 0:c.enableDiagonalMovement)||void 0===D||D,this.enableRotationOnMove=null===(M=null==c?void 0:c.enableRotationOnMove)||void 0===M||M,this.enableAcceleration=null===(j=null==c?void 0:c.enableAcceleration)||void 0===j||j,this.accelerationFactor=null!==(S=null==c?void 0:c.accelerationFactor)&&void 0!==S?S:1.5,this.onKeyDown=this._onKeyDown.bind(this),this.onKeyUp=this._onKeyUp.bind(this),this.onMouseDown=this._onMouseDown.bind(this),this.onMouseUp=this._onMouseUp.bind(this),this.onMouseMove=this._onMouseMove.bind(this),this.onMouseWheel=this._onMouseWheel.bind(this),this.connect()}_getForwardVector(){return this._objectLocalDirection.copy(this._forwardDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection}_getSideVector(){return this._objectLocalDirection.copy(this._forwardDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection.cross(this.object.up),this._objectLocalDirection}_accumulateDirection(){return this._accumulatedDirection.set(0,0,0),$.forward&&this._accumulatedDirection.add(this._getForwardVector()),$.backward&&this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)),$.leftward&&this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)),$.rightward&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection.normalize()}_getMostRecentDirection(){this._accumulatedDirection.set(0,0,0);let e=null,t=0;return Object.entries($).forEach((([i,o])=>{o>t&&(e=i,t=o)})),"forward"===e?this._accumulatedDirection.add(this._getForwardVector()):"backward"===e?this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)):"leftward"===e?this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)):"rightward"===e&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection}updateControls(e){let t,i=e*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);this.enableAcceleration&&$.accelerate&&(i*=this.accelerationFactor),t=this.enableDiagonalMovement?this._accumulateDirection():this._getMostRecentDirection(),t.lengthSq()>1e-10&&(this.velocity.add(t.multiplyScalar(i)),this.enableRotationOnMove&&this.object.lookAt(this.object.position.clone().add(t))),$.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce),this.object.updateMatrixWorld()}updateSync(){return"always"===this.axisSync||"move"===this.axisSync&&($.forward||$.backward||$.leftward||$.rightward)?(this.camera.getWorldDirection(this._forwardDirection),void this.object.lookAt(this.object.position.clone().add(this._getForwardVector()))):void 0}updateCamera(){this._cameraLookAtPosition.copy(this.object.position).add(this.cameraLookAtOffset),this._cameraLerpPosition.lerp(this._cameraLookAtPosition,this.cameraLerpFactor),this._spherical.radius=this.cameraPositionOffset.distanceTo(this.cameraLookAtOffset),this.camera.position.setFromSpherical(this._spherical).add(this._cameraLerpPosition),this.camera.lookAt(this._cameraLookAtPosition),this.camera.updateMatrixWorld()}update(e){super.update(e),this.updateCamera(),this.updateSync(),this.updateControls(e)}connect(){var e,t,i;super.connect(),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.addEventListener("mousedown",this.onMouseDown),document.addEventListener("mouseup",this.onMouseUp),null===(t=this.domElement)||void 0===t||t.addEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.addEventListener("wheel",this.onMouseWheel)}disconnect(){var e,t,i;super.disconnect(),document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mouseup",this.onMouseUp),null===(t=this.domElement)||void 0===t||t.removeEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.removeEventListener("wheel",this.onMouseWheel)}dispose(){this.disconnect(),super.dispose()}_onKeyDown(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){$[t]=++this._keyCount;break}}_onKeyUp(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){$[t]=0;break}}}const ie={forward:0,backward:0,leftward:0,rightward:0,jump:0,accelerate:0},oe={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],leftward:["KeyA","ArrowLeft"],rightward:["KeyD","ArrowRight"],jump:["Space"],accelerate:["ShiftLeft"]};class ne extends J{constructor({object:t,domElement:i,worldObject:o,camera:n,actionKeys:s,cameraOptions:a,animationOptions:r,physicsOptions:c}){var h,u,m,p,_,w,y,b,f,g,D,M,j,S;super(t,i,o,r,c),this._spherical=new v,this._keyCount=0,this._forwardDirection=new e,this._objectLocalDirection=new e,this._accumulatedDirection=new e,this._cameraLookAtPosition=new e,this._cameraLerpPosition=new e,this._onMouseDown=()=>{var e;null===(e=this.domElement)||void 0===e||e.requestPointerLock()},this._onMouseMove=e=>{document.pointerLockElement===this.domElement&&(this._spherical.theta-=e.movementX*this.rotateSpeed/100,this._spherical.phi-=e.movementY*this.rotateSpeed/100,this._spherical.phi=Math.max(.01,Math.min(Math.PI-.01,this._spherical.phi)))},this._onMouseWheel=e=>{if(!this.enableZoom)return;if(!(this.camera instanceof l||this.camera instanceof d))return console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),void(this.enableZoom=!1);const t=Math.pow(.95,this.zoomSpeed*Math.abs(.01*e.deltaY));e.deltaY>0?this.camera.zoom*=t:e.deltaY<0&&(this.camera.zoom/=t),this.camera.updateProjectionMatrix()},this.actionKeys=null!=s?s:oe,this.camera=n,this.cameraPositionOffset=null!==(h=null==a?void 0:a.posOffset)&&void 0!==h?h:new e(0,2,-2),this.cameraLookAtOffset=null!==(u=null==a?void 0:a.lookAtOffset)&&void 0!==u?u:new e(0,1,0),this.cameraLerpFactor=null!==(m=null==a?void 0:a.cameraLerpFactor)&&void 0!==m?m:1;const L=this.cameraPositionOffset.clone().sub(this.cameraLookAtOffset);this._spherical.setFromVector3(L),this.axisSync=null!==(p=null==a?void 0:a.axisSync)&&void 0!==p?p:"move",this.enableZoom=null===(_=null==a?void 0:a.enableZoom)||void 0===_||_,this.zoomSpeed=null!==(w=null==a?void 0:a.zoomSpeed)&&void 0!==w?w:1,this.jumpForce=null!==(y=null==c?void 0:c.jumpForce)&&void 0!==y?y:15,this.groundMoveSpeed=null!==(b=null==c?void 0:c.groundMoveSpeed)&&void 0!==b?b:30,this.floatMoveSpeed=null!==(f=null==c?void 0:c.floatMoveSpeed)&&void 0!==f?f:8,this.rotateSpeed=null!==(g=null==c?void 0:c.rotateSpeed)&&void 0!==g?g:1,this.enableDiagonalMovement=null===(D=null==c?void 0:c.enableDiagonalMovement)||void 0===D||D,this.enableRotationOnMove=null===(M=null==c?void 0:c.enableRotationOnMove)||void 0===M||M,this.enableAcceleration=null===(j=null==c?void 0:c.enableAcceleration)||void 0===j||j,this.accelerationFactor=null!==(S=null==c?void 0:c.accelerationFactor)&&void 0!==S?S:1.5,this.onKeyDown=this._onKeyDown.bind(this),this.onKeyUp=this._onKeyUp.bind(this),this.onMouseDown=this._onMouseDown.bind(this),this.onMouseMove=this._onMouseMove.bind(this),this.onMouseWheel=this._onMouseWheel.bind(this),this.connect()}_getForwardVector(){return this._objectLocalDirection.copy(this._forwardDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection}_getSideVector(){return this._objectLocalDirection.copy(this._forwardDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection.cross(this.object.up),this._objectLocalDirection}_accumulateDirection(){return this._accumulatedDirection.set(0,0,0),ie.forward&&this._accumulatedDirection.add(this._getForwardVector()),ie.backward&&this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)),ie.leftward&&this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)),ie.rightward&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection.normalize()}_getMostRecentDirection(){this._accumulatedDirection.set(0,0,0);let e=null,t=0;return Object.entries(ie).forEach((([i,o])=>{o>t&&(e=i,t=o)})),"forward"===e?this._accumulatedDirection.add(this._getForwardVector()):"backward"===e?this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)):"leftward"===e?this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)):"rightward"===e&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection}updateControls(e){let t,i=e*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);this.enableAcceleration&&ie.accelerate&&(i*=this.accelerationFactor),t=this.enableDiagonalMovement?this._accumulateDirection():this._getMostRecentDirection(),t.lengthSq()>1e-10&&(this.velocity.add(t.multiplyScalar(i)),this.enableRotationOnMove&&this.object.lookAt(this.object.position.clone().add(t))),ie.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce),this.object.updateMatrixWorld()}updateSync(){return"always"===this.axisSync||"move"===this.axisSync&&(ie.forward||ie.backward||ie.leftward||ie.rightward)?(this.camera.getWorldDirection(this._forwardDirection),void this.object.lookAt(this.object.position.clone().add(this._getForwardVector()))):void 0}updateCamera(){this._cameraLookAtPosition.copy(this.object.position).add(this.cameraLookAtOffset),this._cameraLerpPosition.lerp(this._cameraLookAtPosition,this.cameraLerpFactor),this._spherical.radius=this.cameraPositionOffset.distanceTo(this.cameraLookAtOffset),this.camera.position.setFromSpherical(this._spherical).add(this._cameraLerpPosition),this.camera.lookAt(this._cameraLookAtPosition),this.camera.updateMatrixWorld()}update(e){super.update(e),this.updateCamera(),this.updateSync(),this.updateControls(e)}connect(){var e,t,i;super.connect(),window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.addEventListener("mousedown",this.onMouseDown),null===(t=this.domElement)||void 0===t||t.addEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.addEventListener("wheel",this.onMouseWheel)}disconnect(){var e,t,i;super.disconnect(),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.removeEventListener("mousedown",this.onMouseDown),null===(t=this.domElement)||void 0===t||t.removeEventListener("mousemove",this.onMouseMove),null===(i=this.domElement)||void 0===i||i.addEventListener("wheel",this.onMouseWheel)}dispose(){this.disconnect(),super.dispose()}_onKeyDown(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){ie[t]=++this._keyCount;break}}_onKeyUp(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){ie[t]=0;break}}}const se={forward:0,backward:0,leftward:0,rightward:0,jump:0,turnUp:0,turnDown:0,turnLeft:0,turnRight:0,accelerate:0},ae={forward:["KeyW"],backward:["KeyS"],leftward:["KeyA"],rightward:["KeyD"],jump:["Space"],turnUp:["ArrowUp"],turnDown:["ArrowDown"],turnLeft:["ArrowLeft"],turnRight:["ArrowRight"],accelerate:["ShiftLeft"]};class re extends J{constructor({object:t,domElement:i,worldObject:o,camera:n,actionKeys:s,cameraOptions:a,animationOptions:r,physicsOptions:c}){var h,u,m,p,_,w,y,b,f,g,D,M,j,S;super(t,i,o,r,c),this._spherical=new v,this._keyCount=0,this._forwardDirection=new e,this._objectLocalDirection=new e,this._accumulatedDirection=new e,this._cameraLookAtPosition=new e,this._cameraLerpPosition=new e,this._onMouseWheel=e=>{if(!this.enableZoom)return;if(!(this.camera instanceof l||this.camera instanceof d))return console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),void(this.enableZoom=!1);const t=Math.pow(.95,this.zoomSpeed*Math.abs(.01*e.deltaY));e.deltaY>0?this.camera.zoom*=t:e.deltaY<0&&(this.camera.zoom/=t),this.camera.updateProjectionMatrix()},this.actionKeys=null!=s?s:ae,this.camera=n,this.cameraPositionOffset=null!==(h=null==a?void 0:a.posOffset)&&void 0!==h?h:new e(0,2,-2),this.cameraLookAtOffset=null!==(u=null==a?void 0:a.lookAtOffset)&&void 0!==u?u:new e(0,1,0),this.cameraLerpFactor=null!==(m=null==a?void 0:a.cameraLerpFactor)&&void 0!==m?m:.5;const L=this.cameraPositionOffset.clone().sub(this.cameraLookAtOffset);this._spherical.setFromVector3(L),this.axisSync=null!==(p=null==a?void 0:a.axisSync)&&void 0!==p?p:"move",this.enableZoom=null===(_=null==a?void 0:a.enableZoom)||void 0===_||_,this.zoomSpeed=null!==(w=null==a?void 0:a.zoomSpeed)&&void 0!==w?w:1,this.jumpForce=null!==(y=null==c?void 0:c.jumpForce)&&void 0!==y?y:15,this.groundMoveSpeed=null!==(b=null==c?void 0:c.groundMoveSpeed)&&void 0!==b?b:30,this.floatMoveSpeed=null!==(f=null==c?void 0:c.floatMoveSpeed)&&void 0!==f?f:8,this.rotateSpeed=null!==(g=null==c?void 0:c.rotateSpeed)&&void 0!==g?g:1,this.enableDiagonalMovement=null===(D=null==c?void 0:c.enableDiagonalMovement)||void 0===D||D,this.enableRotationOnMove=null===(M=null==c?void 0:c.enableRotationOnMove)||void 0===M||M,this.enableAcceleration=null===(j=null==c?void 0:c.enableAcceleration)||void 0===j||j,this.accelerationFactor=null!==(S=null==c?void 0:c.accelerationFactor)&&void 0!==S?S:1.5,this.onKeyDown=this._onKeyDown.bind(this),this.onKeyUp=this._onKeyUp.bind(this),this.onMouseWheel=this._onMouseWheel.bind(this),this.connect()}_getForwardVector(){return this._objectLocalDirection.copy(this._forwardDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection}_getSideVector(){return this._objectLocalDirection.copy(this._forwardDirection),this._objectLocalDirection.y=0,this._objectLocalDirection.normalize(),this._objectLocalDirection.cross(this.object.up),this._objectLocalDirection}_accumulateDirection(){return this._accumulatedDirection.set(0,0,0),se.forward&&this._accumulatedDirection.add(this._getForwardVector()),se.backward&&this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)),se.leftward&&this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)),se.rightward&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection.normalize()}_getMostRecentDirection(){this._accumulatedDirection.set(0,0,0);let e=null,t=0;return Object.entries(se).forEach((([i,o])=>{o>t&&(e=i,t=o)})),"forward"===e?this._accumulatedDirection.add(this._getForwardVector()):"backward"===e?this._accumulatedDirection.add(this._getForwardVector().multiplyScalar(-1)):"leftward"===e?this._accumulatedDirection.add(this._getSideVector().multiplyScalar(-1)):"rightward"===e&&this._accumulatedDirection.add(this._getSideVector()),this._accumulatedDirection}updateControls(e){let t,i=e*(this.isGrounded?this.groundMoveSpeed:this.floatMoveSpeed);this.enableAcceleration&&se.accelerate&&(i*=this.accelerationFactor),t=this.enableDiagonalMovement?this._accumulateDirection():this._getMostRecentDirection(),t.lengthSq()>1e-10&&(this.velocity.add(t.multiplyScalar(i)),this.enableRotationOnMove&&this.object.lookAt(this.object.position.clone().add(t))),se.jump&&this.isGrounded&&(this.velocity.y=this.jumpForce),this.object.updateMatrixWorld()}updateSync(){return"always"===this.axisSync||"move"===this.axisSync&&(se.forward||se.backward||se.leftward||se.rightward)?(this.camera.getWorldDirection(this._forwardDirection),void this.object.lookAt(this.object.position.clone().add(this._getForwardVector()))):void 0}updateCamera(e){const t=this.rotateSpeed*e;se.turnUp&&(this._spherical.phi-=t),se.turnDown&&(this._spherical.phi+=t),se.turnLeft&&(this._spherical.theta+=t),se.turnRight&&(this._spherical.theta-=t),this._spherical.phi=Math.max(.01,Math.min(Math.PI-.01,this._spherical.phi)),this._cameraLookAtPosition.copy(this.object.position).add(this.cameraLookAtOffset),this._cameraLerpPosition.lerp(this._cameraLookAtPosition,this.cameraLerpFactor),this._spherical.radius=this.cameraPositionOffset.distanceTo(this.cameraLookAtOffset),this.camera.position.setFromSpherical(this._spherical).add(this._cameraLerpPosition),this.camera.lookAt(this._cameraLookAtPosition),this.camera.updateMatrixWorld()}update(e){super.update(e),this.updateCamera(e),this.updateSync(),this.updateControls(e)}connect(){var e;super.connect(),window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.addEventListener("wheel",this.onMouseWheel)}disconnect(){var e;super.disconnect(),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),null===(e=this.domElement)||void 0===e||e.addEventListener("wheel",this.onMouseWheel)}dispose(){this.disconnect(),super.dispose()}_onKeyDown(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){se[t]=++this._keyCount;break}}_onKeyUp(e){for(const[t,i]of Object.entries(this.actionKeys))if(null==i?void 0:i.includes(e.code)){se[t]=0;break}}}class ce extends _{constructor(t,i=16777215){super(),this.type="PhysicsControlsHelper",this._capsulePosition=new e,this.controls=t;const o=new w(t.collider.radius,t.collider.height-2*t.collider.radius);if(this.capsuleHelper=new y(o,new b({color:i,toneMapped:!1})),this.add(this.capsuleHelper),t.boundary){const e=t.boundary.x.max-t.boundary.x.min,o=t.boundary.y.max-t.boundary.y.min,n=t.boundary.z.max-t.boundary.z.min,s=new f(e,o,n,e,o,n);this.boundaryHelper=new y(s,new b({color:i,toneMapped:!1})),this.boundaryHelper.position.set(t.boundary.x.min+e/2,t.boundary.y.min+o/2,t.boundary.z.min+n/2),this.add(this.boundaryHelper)}this.matrixAutoUpdate=!1,this.update()}update(){this.controls.object.updateMatrixWorld(!0),this.controls.object.getWorldPosition(this._capsulePosition),this._capsulePosition.y+=this.controls.collider.height/2,this.capsuleHelper.position.copy(this._capsulePosition),this.updateMatrix()}dispose(){this.capsuleHelper.geometry.dispose(),this.capsuleHelper.material.dispose(),this.boundaryHelper&&(this.boundaryHelper.geometry.dispose(),this.boundaryHelper.material.dispose()),this.clear()}}export{H as FirstPersonKeyboardControls,N as FirstPersonMouseDragControls,Q as FirstPersonPointerLockControls,G as PhysicsControls,ce as PhysicsControlsHelper,re as ThirdPersonKeyboardControls,te as ThirdPersonMouseDragControls,ne as ThirdPersonPointerLockControls};
